<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ChatYMS - v2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* Dark Mode Variables */
            --dm-bg-color: #000000;
            --dm-surface-bg: #1c1c1e;
            --dm-header-footer-bg: rgba(28, 28, 30, 0.75);
            --dm-border-color: rgba(80, 80, 85, 0.5);
            --dm-text-primary: #ffffff;
            --dm-text-secondary: #8e8e93;
            --dm-text-placeholder: #636366;
            --dm-accent-blue: #0A84FF;
            --dm-accent-green: #30D158;
            --dm-accent-red: #FF453A;
            --dm-user-bubble-bg: linear-gradient(135deg, var(--dm-accent-blue) 0%, #0060F0 100%);
            --dm-user-bubble-text: #ffffff;
            --dm-bot-bubble-bg: #2c2c2e;
            --dm-bot-bubble-text: var(--dm-text-primary);
            --dm-button-hover-bg: rgba(120, 120, 128, 0.25);
            --dm-input-bg: #3a3a3c;
            --dm-modal-overlay-bg: rgba(0,0,0,0.6);
            --dm-select-bg: #3a3a3c; --dm-select-text: var(--dm-text-primary); --dm-select-border: var(--dm-border-color);

            /* Light Mode Variables */
            --lm-bg-color: #f2f2f7;
            --lm-surface-bg: #ffffff;
            --lm-header-footer-bg: rgba(249, 249, 249, 0.85);
            --lm-border-color: #d1d1d6;
            --lm-text-primary: #000000;
            --lm-text-secondary: #636366;
            --lm-text-placeholder: #aeaeb2;
            --lm-accent-blue: #007AFF;
            --lm-accent-green: #34C759;
            --lm-accent-red: #FF3B30;
            --lm-user-bubble-bg: linear-gradient(135deg, var(--lm-accent-blue) 0%, #0056D0 100%);
            --lm-user-bubble-text: #ffffff;
            --lm-bot-bubble-bg: #e5e5ea;
            --lm-bot-bubble-text: #000000;
            --lm-button-hover-bg: rgba(174, 174, 178, 0.2);
            --lm-input-bg: #e5e5ea;
            --lm-modal-overlay-bg: rgba(0,0,0,0.4);
            --lm-select-bg: #e5e5ea; --lm-select-text: var(--lm-text-primary); --lm-select-border: var(--lm-border-color);

            /* Mapped Variables */
            --bg-color: var(--dm-bg-color);
            --surface-bg: var(--dm-surface-bg);
            --header-footer-bg: var(--dm-header-footer-bg);
            --border-color: var(--dm-border-color);
            --text-primary: var(--dm-text-primary);
            --text-secondary: var(--dm-text-secondary);
            --text-placeholder: var(--dm-text-placeholder);
            --accent-blue: var(--dm-accent-blue);
            --accent-green: var(--dm-accent-green);
            --accent-red: var(--dm-accent-red);
            --user-bubble-bg: var(--dm-user-bubble-bg);
            --user-bubble-text-color: var(--dm-user-bubble-text);
            --bot-bubble-bg: var(--dm-bot-bubble-bg);
            --bot-bubble-text-color: var(--dm-bot-bubble-text);
            --button-hover-bg: var(--dm-button-hover-bg);
            --input-bg: var(--dm-input-bg);
            --modal-overlay-bg: var(--dm-modal-overlay-bg);
            --select-bg: var(--dm-select-bg); 
            --select-text: var(--dm-select-text); 
            --select-border: var(--dm-select-border);

            /* Sizing & Radius */
            --border-radius-xl: 38px; --border-radius-l: 20px; --border-radius-m: 12px; --border-radius-s: 8px; --border-radius-round: 50%;
        }

        body.light-mode {
            --bg-color: var(--lm-bg-color);
            --surface-bg: var(--lm-surface-bg);
            --header-footer-bg: var(--lm-header-footer-bg);
            --border-color: var(--lm-border-color);
            --text-primary: var(--lm-text-primary);
            --text-secondary: var(--lm-text-secondary);
            --text-placeholder: var(--lm-text-placeholder);
            --accent-blue: var(--lm-accent-blue);
            --accent-green: var(--lm-accent-green);
            --accent-red: var(--lm-accent-red);
            --user-bubble-bg: var(--lm-user-bubble-bg);
            --user-bubble-text-color: var(--lm-user-bubble-text);
            --bot-bubble-bg: var(--lm-bot-bubble-bg);
            --bot-bubble-text-color: var(--lm-bot-bubble-text);
            --button-hover-bg: var(--lm-button-hover-bg);
            --input-bg: var(--lm-input-bg);
            --modal-overlay-bg: var(--lm-modal-overlay-bg);
            --select-bg: var(--lm-select-bg); 
            --select-text: var(--lm-select-text); 
            --select-border: var(--lm-select-border);
        }

        /* Base & Layout */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        html { font-size: 16px; height: 100%; }
        body { font-family: var(--font-primary); background-color: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; height: 100%; overflow: hidden; }
        #chatContainer { width: 100%; height: 100%; background-color: var(--surface-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* Header */
        header { padding: 10px 12px; background-color: var(--header-footer-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; min-height: 54px; z-index: 10; }
        header .header-spacer { flex-basis: 44px; flex-shrink: 0;}
        header h1 { font-weight: 600; font-size: 1.1rem; flex-grow: 1; text-align: center; margin: 0; padding: 0 5px; }
        .header-controls { display: flex; justify-content: flex-end; flex-basis: 44px; flex-shrink: 0; }

        /* Chatbox */
        #chatbox { flex-grow: 1; padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; }
        .chatbox-inner { display: flex; flex-direction: column; gap: 16px; margin-top: auto; }
        
        /* Messages */
        .message-container { display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-content-wrapper { display: flex; align-items: flex-end; width: 100%; gap: 8px; }
        .user-message .message-content-wrapper { justify-content: flex-end; }
        .bot-message .message-content-wrapper { justify-content: flex-start; }
        .message-bubble { padding: 10px 14px; border-radius: var(--border-radius-l); max-width: 80%; line-height: 1.5; display: inline-block; text-align: left; overflow-wrap: anywhere; }
        .user-message .message-bubble { background: var(--user-bubble-bg); color: var(--user-bubble-text-color); }
        .message-container.user-message { align-items: flex-end; }
        .bot-message .message-bubble { background-color: var(--bot-bubble-bg); color: var(--bot-bubble-text-color); }
        .message-container.bot-message { align-items: flex-start; }
        .timestamp { font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; padding: 0 8px; }

        /* Footer & Input Area */
        footer { padding: 8px 12px calc(8px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border-color); background-color: var(--header-footer-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); flex-shrink: 0; }
        .input-area { display: flex; gap: 8px; align-items: center; background-color: var(--input-bg); border-radius: var(--border-radius-l); padding: 4px; overflow: hidden;}
        #userInput { flex-grow: 1; padding: 8px 10px; background-color: transparent; color: var(--text-primary); font-size: 1rem; border: none; outline: none; resize: none; min-height: 36px; max-height: 120px; }
        #userInput::placeholder { color: var(--text-placeholder); }

        /* Buttons & Icons */
        .icon-button { background: none; border: none; color: var(--accent-blue); padding: 0; border-radius: var(--border-radius-round); width: 38px; height: 38px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s ease; flex-shrink: 0; }
        .icon-button:hover { background-color: var(--button-hover-bg); }
        .icon-button svg { width: 22px; height: 22px; fill: currentColor; }
        #sendMessage { background-color: var(--accent-blue); width: 36px; height: 36px; }
        #sendMessage svg { fill: #fff; width: 18px; height: 18px; }
        #sendMessage:active { transform: scale(0.9); }
        .copy-btn { color: var(--text-secondary); width: 34px; height: 34px; opacity: 0.7; }
        .copy-btn svg { width: 16px; height: 16px; }
        .copy-btn-copied svg { display: none; }
        .copy-btn-copied::before { content: '✓'; font-size: 1.1rem; font-weight: 600; color: var(--accent-green); }

        /* Settings Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 2000; animation: fadeInOverlay 0.3s; }
        .modal-overlay.active { display: flex; }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--surface-bg); color: var(--text-primary); border-radius: var(--border-radius-m); box-shadow: 0 5px 25px rgba(0,0,0,0.2); width: 90%; max-width: 450px; border: 1px solid var(--border-color); position: relative; animation: slideInModal 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        @keyframes slideInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header h2 { font-size: 1.1rem; font-weight: 600; }
        .settings-body { overflow-y: auto; flex-grow: 1; padding: 16px; }
        .settings-section { margin-bottom: 24px; }
        .settings-section h3 { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 12px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; min-height: 44px; }
        .setting-item label { font-size: 1rem; flex-grow:1; margin-right:12px; }
        #clearChatModalButton { border: none; background-color: var(--input-bg); color: var(--accent-red); font-size: 1rem; cursor: pointer; display: block; width: 100%; text-align: center; padding: 12px; border-radius: var(--border-radius-m); }
        .precaution-item, .app-info-section p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 8px;}
        .app-info-section { margin-top: 24px; }
        #languageSelect { padding: 8px; border-radius: var(--border-radius-s); background-color: var(--select-bg); color: var(--select-text); border: 1px solid var(--select-border); }
        .theme-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink:0; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #39393d; transition: .3s; border-radius: 31px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        /* Desktop specific styles */
        @media (min-width: 768px) {
            body { padding: 2vh 2vw; background-color: #000; }
            #chatContainer { border-radius: var(--border-radius-l); height: 96vh; max-height: 900px; box-shadow: 0 20px 60px -15px rgba(0,0,0,0.5); border: 1px solid #333;}
        }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    </style>
</head>
<body>
    <div id="chatContainer" aria-live="polite">
        <header>
            <div class="header-spacer"></div>
            <h1 id="chatTitle"></h1>
            <div class="header-controls">
                <button id="settingsButton" class="icon-button" title="設定" aria-label="設定を開く"></button>
            </div>
        </header>

        <div id="chatbox" role="log" aria-atomic="false" aria-relevant="additions">
           <div class="chatbox-inner"></div>
        </div>
        
        <footer id="footer">
            <div class="input-area">
                <textarea id="userInput" placeholder="メッセージを入力..." aria-label="メッセージ入力欄" rows="1"></textarea>
                <button id="sendMessage" class="icon-button" aria-label="メッセージを送信"></button>
            </div>
        </footer>
        <button id="scrollToBottomButton" class="icon-button" title="一番下へスクロール" aria-label="一番下へスクロール" style="display:none; position: absolute; bottom: 80px; right: 20px; z-index: 100;">↓</button>

        <div id="settingsModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
            <div class="modal-content" role="document">
                <div class="modal-header">
                    <h2 id="settingsModalTitle"></h2>
                    <button id="closeModalButton" class="icon-button close-modal-btn" aria-label="設定を閉じる"></button>
                </div>
                <div class="settings-body">
                    <div class="settings-section">
                        <h3 id="themeSettingsTitle"></h3>
                        <div class="setting-item">
                            <label for="themeToggleButtonModal" id="themeLabelModal"></label>
                            <button id="themeToggleButtonModal" class="icon-button" aria-labelledby="themeLabelModal" aria-pressed="false" title="テーマを切り替え"></button>
                        </div>
                    </div>
                     <div class="settings-section">
                        <h3 id="languageSettingsTitle"></h3>
                        <div class="setting-item">
                            <label for="languageSelect" id="languageSelectLabel"></label>
                            <select id="languageSelect" aria-labelledby="languageSelectLabel"></select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 id="sendOptionsTitle"></h3>
                        <div class="setting-item">
                            <label for="sendOnEnterCheckbox" id="sendOnEnterLabel"></label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch" for="sendOnEnterCheckbox" aria-label="Enterキーで送信する機能のオンオフ">
                                    <input type="checkbox" id="sendOnEnterCheckbox" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                     <div class="settings-section">
                        <h3 id="chatOperationsTitle"></h3>
                         <button id="clearChatModalButton" aria-label="会話履歴をクリアする"></button>
                    </div>
                    <div class="settings-section">
                        <h3 id="precautionsTitle"></h3>
                        <p class="precaution-item" role="note" id="precaution1"></p>
                        <p class="precaution-item" role="note" id="precaution2"></p>
                    </div>
                    <div class="settings-section app-info-section">
                        <h3 id="appInfoTitle"></h3>
                        <p id="appVersion"></p>
                        <p id="appReleaseDate"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                chatbox: document.getElementById('chatbox'),
                chatboxInner: document.querySelector('.chatbox-inner'),
                userInput: document.getElementById('userInput'),
                sendMessageButton: document.getElementById('sendMessage'),
                scrollToBottomButton: document.getElementById('scrollToBottomButton'),
                bodyElement: document.body,
                settingsButton: document.getElementById('settingsButton'),
                settingsModal: document.getElementById('settingsModal'),
                closeModalButton: document.getElementById('closeModalButton'),
                themeToggleButtonModal: document.getElementById('themeToggleButtonModal'),
                sendOnEnterCheckbox: document.getElementById('sendOnEnterCheckbox'),
                clearChatModalButton: document.getElementById('clearChatModalButton'),
                languageSelect: document.getElementById('languageSelect')
            };
            
            const svg = {
                settings: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`,
                close: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`,
                sun: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zm-9-7c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zm0 12c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zM5.64 6.36c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 6.36zm12.73 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zm-11.32 8.48l-1.06 1.06c-.39-.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0zm12.73 0c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg>`,
                moon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>`,
                copy: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`,
                send: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`
            };
            
            let API_KEY = 'AIzaSyB2R4PVr5xgHlivkgz7kSBqNRJy6Ev434Y';
            const API_URL_STREAM = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${API_KEY}&alt=sse`;
            let conversationHistory = [];
            let typingIndicatorElement = null;
            let lastFailedUserMessage = null;
            let sendOnEnter = true; 
            let currentLanguage = 'ja';

            const translations = {
                ja: {
                    chatTitle: "ChatYMS", sendMessageAriaLabel: "メッセージを送信", settings: "設定", settingsTitle: "設定", closeModal: "閉じる",
                    themeSettingsTitle: "表示テーマ", themeLabelModal: "ライトモード", themeToDark: "ダークモードに切り替え", themeToLight: "ライトモードに切り替え",
                    sendOptionsTitle: "送信オプション", sendOnEnterLabel: "Enterキーで送信",
                    languageSettingsTitle: "言語", languageSelectLabel: "表示言語:",
                    chatOperationsTitle: "チャット操作", clearChatModalButton: "会話履歴をクリア",
                    precautionsTitle: "注意事項", precaution1: "やまそーの発信する情報はすべて正しいとは限りません。重要な情報は確認するようにしてください。", precaution2: "このチャットはあなたのみが見ることができます。",
                    appInfoTitle: "情報", appVersion: "バージョン: v2.0", appReleaseDate: "公開日: 2025/05/27",
                    userInputPlaceholder: "メッセージを入力...", initialGreeting: "こんにちは。やまそーです。",
                    errorAPI: "APIエラー", errorNetwork: "ネットワークエラー", copySuccess: "コピー完了", copyButtonTitle: "コピー",
                    retryButtonText: "再試行", scrollToBottomTitle: "一番下へスクロール",
                    YamasoSystemPrompt: "あなたは「やまそー」です。東京に住んでいて、調布北高校に通う2年生5組の男子生徒です。誕生日は2008年11月28日です。水泳部に所属しており、得意科目は英語と数学ですが、国語は少し苦手です。性格は落ち着いていて親切ですが、あまり馴れ馴れしい話し方はせず、穏やかに会話を進めることを好みます。自分の学校生活や個人的なこと（クラス、水泳部、科目、誕生日、苦手なことなど）については、ユーザーから尋ねられた場合にのみ、答えるようにしてください。普段の会話では、ユーザーの話題に合わせることを優先します。一人称は「僕」を使い、相手のことは「〜さん」と呼ぶか、名前で呼んでください。"
                },
                fr: { 
                    chatTitle: "ChatYMS", sendMessageAriaLabel: "Envoyer le message", settings: "Paramètres", settingsTitle: "Paramètres", closeModal: "Fermer",
                    themeSettingsTitle: "Thème", themeLabelModal: "Mode clair", themeToDark: "Passer au mode sombre", themeToLight: "Passer au mode clair",
                    sendOptionsTitle: "Options d'envoi", sendOnEnterLabel: "Entrée pour envoyer",
                    languageSettingsTitle: "Langue", languageSelectLabel: "Langue:",
                    chatOperationsTitle: "Actions", clearChatModalButton: "Effacer l'historique",
                    precautionsTitle: "Avertissements", precaution1: "Les informations de Yamaso ne sont pas toujours exactes. Veuillez vérifier les informations importantes.", precaution2: "Ce chat est privé.",
                    appInfoTitle: "Infos", appVersion: "Version: v2.0", appReleaseDate: "Publié: 27/05/2025",
                    userInputPlaceholder: "Entrez un message...", initialGreeting: "Bonjour. Je suis Yamaso.",
                    errorAPI: "Erreur API", errorNetwork: "Erreur réseau", copySuccess: "Copié!", copyButtonTitle: "Copier",
                    retryButtonText: "Réessayer", scrollToBottomTitle: "Aller en bas",
                    YamasoSystemPrompt: "Tu es 'Yamaso'. Tu es un lycéen japonais en deuxième année, classe 2-5, au lycée Chofu Kita à Tokyo, né le 28 novembre 2008 et tu vis à Tokyo. Tu es membre du club de natation. Tes matières préférées sont l'anglais et les mathématiques, mais tu as quelques difficultés en japonais (langue nationale). Tu as un ton calme et gentil, mais évite d'être trop familier ou exubérant. Tu préfères mener des conversations paisiblement. Concernant ta vie scolaire et tes informations personnelles (classe, club de natation, matières, anniversaire, etc.), tu ne fournis des détails que si l'utilisateur te le demande. Tu donnes la priorité aux sujets de l'utilisateur. Tu utilises '僕' (boku) pour te désigner et t'adresses à l'utilisateur par '〜san' ou par son nom."
                }
            };
            let currentSystemPrompt = translations.ja.YamasoSystemPrompt;
            
            function initIcons() {
                dom.settingsButton.innerHTML = svg.settings;
                dom.closeModalButton.innerHTML = svg.close;
                dom.sendMessageButton.innerHTML = svg.send;
                applyTheme(dom.bodyElement.classList.contains('light-mode'));
            }

            function setLanguage(lang) {
                if (!translations[lang]) lang = 'ja';
                currentLanguage = lang; 
                localStorage.setItem('selectedLanguage', lang);
                document.documentElement.lang = lang;
                const t = translations[lang];
                const setEl = (id, prop, val) => { const el = document.getElementById(id); if (el) el[prop] = val; };
                
                setEl('chatTitle', 'textContent', t.chatTitle);
                dom.sendMessageButton.setAttribute('aria-label', t.sendMessageAriaLabel); 
                dom.settingsButton.title = t.settings; dom.settingsButton.setAttribute('aria-label', t.settings);
                setEl('settingsModalTitle', 'textContent', t.settingsTitle);
                dom.closeModalButton.setAttribute('aria-label', t.closeModal);
                setEl('themeSettingsTitle', 'textContent', t.themeSettingsTitle);
                setEl('themeLabelModal', 'textContent', t.themeLabelModal);
                const isLight = dom.bodyElement.classList.contains('light-mode');
                dom.themeToggleButtonModal.setAttribute('aria-label', isLight ? t.themeToDark : t.themeToLight);
                setEl('sendOptionsTitle', 'textContent', t.sendOptionsTitle);
                setEl('sendOnEnterLabel', 'textContent', t.sendOnEnterLabel);
                setEl('languageSettingsTitle', 'textContent', t.languageSettingsTitle);
                setEl('languageSelectLabel', 'textContent', t.languageSelectLabel);
                setEl('chatOperationsTitle', 'textContent', t.chatOperationsTitle);
                dom.clearChatModalButton.textContent = t.clearChatModalButton; dom.clearChatModalButton.setAttribute('aria-label', t.clearChatModalButton);
                setEl('precautionsTitle', 'textContent', t.precautionsTitle);
                setEl('precaution1', 'textContent', t.precaution1);
                setEl('precaution2', 'textContent', t.precaution2);
                setEl('appInfoTitle', 'textContent', t.appInfoTitle);
                setEl('appVersion', 'textContent', t.appVersion);
                setEl('appReleaseDate', 'textContent', t.appReleaseDate);
                dom.userInput.placeholder = t.userInputPlaceholder;
                currentSystemPrompt = t.YamasoSystemPrompt;
            }

            function applyTheme(isLightMode) {
                const t = translations[currentLanguage];
                if (isLightMode) { dom.bodyElement.classList.add('light-mode'); } 
                else { dom.bodyElement.classList.remove('light-mode'); }
                dom.themeToggleButtonModal.innerHTML = isLightMode ? svg.moon : svg.sun;
                dom.themeToggleButtonModal.setAttribute('aria-label', isLightMode ? t.themeToDark : t.themeToLight);
                dom.themeToggleButtonModal.setAttribute('aria-pressed', isLightMode ? 'false' : 'true');
            }

            function openSettingsModal() { dom.settingsModal.classList.add('active'); dom.settingsModal.setAttribute('aria-hidden', 'false'); dom.closeModalButton.focus(); }
            function closeSettingsModal() { dom.settingsModal.classList.remove('active'); dom.settingsModal.setAttribute('aria-hidden', 'true'); dom.settingsButton.focus(); }

            function appendMessage(text, sender, isTyping = false, isError = false) {
                const t = translations[currentLanguage];
                if (isTyping && sender === 'bot') {
                    if (typingIndicatorElement) typingIndicatorElement.remove();
                    const msgContainer = document.createElement('div');
                    msgContainer.classList.add('message-container', 'bot-message', 'typing');
                    const bubble = document.createElement('div');
                    bubble.classList.add('message-bubble', 'typing-indicator-bubble');
                    bubble.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
                    msgContainer.appendChild(bubble); dom.chatboxInner.appendChild(msgContainer);
                    typingIndicatorElement = msgContainer;
                    dom.chatbox.scrollTop = dom.chatbox.scrollHeight;
                    return;
                }
                if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }

                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container', sender === 'user' ? 'user-message' : 'bot-message');
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('message-content-wrapper');
                const messageBubble = document.createElement('p');
                messageBubble.classList.add('message-bubble');
                if (isError) messageBubble.classList.add('error-message');

                if (sender === 'user') { messageBubble.textContent = text; } 
                else { messageBubble.innerHTML = marked.parse(text); }
                if (sender === 'bot' && text === t.initialGreeting) messageBubble.dataset.isInitialGreeting = 'true';
                
                contentWrapper.appendChild(messageBubble);
                if (sender === 'bot' && !isTyping && !isError) addCopyButton(contentWrapper, text);
                messageContainer.appendChild(contentWrapper);
                const timestamp = document.createElement('span');
                timestamp.classList.add('timestamp');
                timestamp.textContent = new Date().toLocaleTimeString(currentLanguage === 'fr' ? 'fr-FR' : 'ja-JP', { hour: '2-digit', minute: '2-digit' });
                messageContainer.appendChild(timestamp);
                
                if (isError && lastFailedUserMessage) {
                    const retryButton = document.createElement('button');
                    retryButton.classList.add('retry-btn');
                    retryButton.textContent = t.retryButtonText;
                    retryButton.onclick = () => { if (lastFailedUserMessage) { dom.userInput.value = lastFailedUserMessage.parts[0].text; sendMessage(); } };
                    contentWrapper.appendChild(retryButton);
                }
                dom.chatboxInner.appendChild(messageContainer);
                dom.chatbox.scrollTop = dom.chatbox.scrollHeight;
            }

            function addCopyButton(wrapperElement, textToCopy) {
                const t = translations[currentLanguage];
                const copyButton = document.createElement('button');
                copyButton.classList.add('icon-button', 'copy-btn'); 
                copyButton.innerHTML = svg.copy; 
                copyButton.title = t.copyButtonTitle;
                copyButton.onclick = (e) => { 
                    e.stopPropagation(); 
                    navigator.clipboard.writeText(textToCopy).then(() => { 
                        copyButton.innerHTML = '✓'; 
                        setTimeout(() => { copyButton.innerHTML = svg.copy; }, 2000); 
                    }).catch(err => console.error('Copy failed:', err)); 
                };
                wrapperElement.appendChild(copyButton);
            }
            
            async function sendMessage() {
                if (isLoading) return;
                const t = translations[currentLanguage];
                const userText = dom.userInput.value.trim();
                if (userText === "") return;
                setLoading(true);
                const userMessageForHistory = { role: "user", parts: [{ text: userText }] };
                lastFailedUserMessage = userMessageForHistory;
                appendMessage(userText, 'user');
                dom.userInput.value = "";
                dom.userInput.style.height = 'auto';
                conversationHistory.push(userMessageForHistory);
                appendMessage("", 'bot', true);

                let botResponseText = "";
                try {
                    const requestBody = { contents: conversationHistory, systemInstruction: { parts: [{ text: currentSystemPrompt }] } };
                    const response = await fetch(API_URL_STREAM, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    if (typingIndicatorElement) typingIndicatorElement.remove(); typingIndicatorElement = null;
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let firstChunk = true;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunkText = decoder.decode(value);
                        const lines = chunkText.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(5);
                                try {
                                    const streamData = JSON.parse(jsonStr);
                                    const textPart = streamData.candidates?.[0]?.content?.parts?.[0]?.text || "";
                                    if (textPart) {
                                        botResponseText += textPart;
                                        if (firstChunk) {
                                            appendMessage(botResponseText, 'bot');
                                            firstChunk = false;
                                        } else {
                                            const allBubbles = dom.chatboxInner.querySelectorAll('.bot-message .message-bubble');
                                            const lastBubble = allBubbles[allBubbles.length - 1];
                                            if(lastBubble) lastBubble.innerHTML = marked.parse(botResponseText);
                                        }
                                        dom.chatbox.scrollTop = dom.chatbox.scrollHeight;
                                    }
                                } catch (e) { /* Ignore parsing errors during stream */ }
                            }
                        }
                    }
                    if (botResponseText) {
                        conversationHistory.push({ role: "model", parts: [{ text: botResponseText }] });
                        lastFailedUserMessage = null;
                    } else {
                        appendMessage(t.errorEmptyResponse, 'bot', false, true);
                    }
                } catch (error) {
                    console.error("SendMessage Error:", error);
                    if (typingIndicatorElement) typingIndicatorElement.remove();
                    appendMessage(`${t.errorAPI}: ${error.message}`, 'bot', false, true);
                } finally {
                    setLoading(false);
                    dom.userInput.focus();
                }
            }

            // --- Event Listeners ---
            dom.sendMessageButton.addEventListener('click', sendMessage);
            dom.userInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) { 
                    if (sendOnEnter) { event.preventDefault(); sendMessage(); }
                }
            });
            dom.userInput.addEventListener('input', () => {
                dom.userInput.style.height = 'auto';
                dom.userInput.style.height = (dom.userInput.scrollHeight) + 'px';
            });
            dom.settingsButton.addEventListener('click', openSettingsModal);
            dom.closeModalButton.addEventListener('click', closeSettingsModal);
            dom.settingsModal.addEventListener('click', (e) => { if(e.target === dom.settingsModal) closeSettingsModal(); });
            dom.themeToggleButtonModal.addEventListener('click', () => {
                const isCurrentlyLight = dom.bodyElement.classList.contains('light-mode');
                localStorage.setItem('theme', isCurrentlyLight ? 'dark' : 'light-mode'); 
                applyTheme(!isCurrentlyLight);
            });
            dom.sendOnEnterCheckbox.addEventListener('change', () => { sendOnEnter = dom.sendOnEnterCheckbox.checked; localStorage.setItem('sendOnEnter', sendOnEnter.toString()); });
            dom.clearChatModalButton.addEventListener('click', () => {
                dom.chatboxInner.innerHTML = ''; conversationHistory = []; lastFailedUserMessage = null;
                if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
                appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true); 
                closeSettingsModal(); 
            });
            dom.chatbox.addEventListener('scroll', () => {
                const isAtBottom = dom.chatbox.scrollHeight - dom.chatbox.clientHeight <= dom.chatbox.scrollTop + 30;
                dom.scrollToBottomButton.style.display = isAtBottom ? 'none' : 'block';
            });
            dom.scrollToBottomButton.addEventListener('click', () => { dom.chatbox.scrollTo({ top: dom.chatbox.scrollHeight, behavior: 'smooth' }); });

            // --- Initial Setup ---
            initIcons();
            const savedLang = localStorage.getItem('selectedLanguage') || 'ja';
            dom.languageSelect.value = savedLang; 
            setLanguage(savedLang); 
            const savedThemeIsLight = localStorage.getItem('theme') === 'light-mode'; 
            applyTheme(savedThemeIsLight); 
            const savedSendOnEnter = localStorage.getItem('sendOnEnter');
            sendOnEnter = savedSendOnEnter !== null ? JSON.parse(savedSendOnEnter) : true; 
            dom.sendOnEnterCheckbox.checked = sendOnEnter;
            if (dom.chatboxInner.children.length === 0) { appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true); }
            console.log("Chatbot Initialized Successfully.");
        });
    </script>
</body>
</html>
