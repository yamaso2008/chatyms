<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ChatYMS - v2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* --- Color Palette --- */
            /* Dark Mode Variables */
            --dm-bg-color: #121212;
            --dm-surface-bg: #1e1e1e;
            --dm-header-footer-bg: rgba(30, 30, 30, 0.7);
            --dm-border-color: #333333;
            --dm-text-primary: #e1e1e1;
            --dm-text-secondary: #aaaaaa;
            --dm-accent-blue: #3d88ff;
            --dm-user-bubble-bg: #3d88ff;
            --dm-user-bubble-text: #ffffff;
            --dm-bot-bubble-bg: #333333;
            --dm-bot-bubble-text: var(--dm-text-primary);
            --dm-button-hover-bg: #2a2a2a;
            --dm-input-bg: #252525;
            --dm-modal-overlay-bg: rgba(0,0,0,0.5);

            /* Light Mode Variables */
            --lm-bg-color: #f0f2f5;
            --lm-surface-bg: #ffffff;
            --lm-header-footer-bg: rgba(255, 255, 255, 0.7);
            --lm-border-color: #e0e0e0;
            --lm-text-primary: #1c1c1c;
            --lm-text-secondary: #555555;
            --lm-accent-blue: #007aff;
            --lm-user-bubble-bg: #007aff;
            --lm-user-bubble-text: #ffffff;
            --lm-bot-bubble-bg: #e9e9eb;
            --lm-bot-bubble-text: #000000;
            --lm-button-hover-bg: #f0f0f0;
            --lm-input-bg: #e9e9eb;
            --lm-modal-overlay-bg: rgba(0,0,0,0.4);

            /* Mapped Variables */
            --bg-color: var(--dm-bg-color);
            --surface-bg: var(--dm-surface-bg);
            --header-footer-bg: var(--dm-header-footer-bg);
            --border-color: var(--dm-border-color);
            --text-primary: var(--dm-text-primary);
            --text-secondary: var(--dm-text-secondary);
            --accent-blue: var(--dm-accent-blue);
            --user-bubble-bg: var(--dm-user-bubble-bg);
            --user-bubble-text-color: var(--dm-user-bubble-text);
            --bot-bubble-bg: var(--dm-bot-bubble-bg);
            --bot-bubble-text-color: var(--dm-bot-bubble-text);
            --button-hover-bg: var(--dm-button-hover-bg);
            --input-bg: var(--dm-input-bg);
            --modal-overlay-bg: var(--dm-modal-overlay-bg);

            /* --- Sizing & Radius --- */
            --border-radius-l: 20px;
            --border-radius-m: 12px;
            --border-radius-round: 50%;
        }

        body.light-mode {
            --bg-color: var(--lm-bg-color);
            --surface-bg: var(--lm-surface-bg);
            --header-footer-bg: var(--lm-header-footer-bg);
            --border-color: var(--lm-border-color);
            --text-primary: var(--lm-text-primary);
            --text-secondary: var(--lm-text-secondary);
            --accent-blue: var(--lm-accent-blue);
            --user-bubble-bg: var(--lm-user-bubble-bg);
            --user-bubble-text-color: var(--lm-user-bubble-text);
            --bot-bubble-bg: var(--lm-bot-bubble-bg);
            --bot-bubble-text-color: var(--lm-bot-bubble-text);
            --button-hover-bg: var(--lm-button-hover-bg);
            --input-bg: var(--lm-input-bg);
            --modal-overlay-bg: var(--lm-modal-overlay-bg);
        }

        /* --- Base & Layout --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; height: 100%; }
        body { font-family: var(--font-primary); background-color: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; height: 100%; overflow: hidden; }
        #chatContainer { width: 100%; height: 100%; background-color: var(--surface-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* --- Header --- */
        header { padding: 10px 16px; background-color: var(--header-footer-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; min-height: 56px; z-index: 10; }
        header .header-spacer { flex-basis: 40px; }
        header h1 { font-weight: 600; font-size: 1.1rem; flex-grow: 1; text-align: center; }
        .header-controls { display: flex; justify-content: flex-end; flex-basis: 40px; }

        /* --- Chatbox --- */
        #chatbox { flex-grow: 1; padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; }
        .chatbox-inner { display: flex; flex-direction: column; gap: 16px; margin-top: auto; }
        
        /* --- Messages --- */
        .message-container { display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .message-content-wrapper { display: flex; align-items: flex-end; width: 100%; gap: 8px; }
        .user-message .message-content-wrapper { justify-content: flex-end; }
        .bot-message .message-content-wrapper { justify-content: flex-start; }
        .message-bubble { padding: 10px 14px; border-radius: var(--border-radius-l); max-width: 80%; line-height: 1.5; display: inline-block; text-align: left; overflow-wrap: anywhere; }
        .user-message .message-bubble { background: var(--user-bubble-bg); color: var(--user-bubble-text-color); }
        .message-container.user-message { align-items: flex-end; }
        .bot-message .message-bubble { background-color: var(--bot-bubble-bg); color: var(--bot-bubble-text-color); }
        .message-container.bot-message { align-items: flex-start; }
        .timestamp { font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; padding: 0 8px; }

        /* --- Footer --- */
        footer { padding: 8px 12px calc(8px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border-color); background-color: var(--header-footer-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); flex-shrink: 0; }
        .input-area { display: flex; gap: 8px; align-items: center; background-color: var(--input-bg); border-radius: var(--border-radius-l); padding: 4px; }
        #userInput { flex-grow: 1; padding: 8px 10px; background-color: transparent; color: var(--text-primary); font-size: 1rem; border: none; outline: none; resize: none; min-height: 36px; max-height: 120px; }
        #userInput::placeholder { color: var(--text-secondary); }

        /* --- Buttons & Icons --- */
        .icon-button { background: none; border: none; color: var(--accent-blue); padding: 0; border-radius: var(--border-radius-round); width: 38px; height: 38px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s ease; flex-shrink: 0; }
        .icon-button:hover { background-color: var(--button-hover-bg); }
        .icon-button svg { width: 22px; height: 22px; fill: currentColor; }
        #sendMessage { background-color: var(--accent-blue); width: 36px; height: 36px; }
        #sendMessage svg { fill: #fff; width: 18px; height: 18px; }
        .copy-btn { color: var(--text-secondary); width: 34px; height: 34px; opacity: 0.7; }
        .copy-btn svg { width: 16px; height: 16px; }
        .copy-btn-copied svg { display: none; }
        .copy-btn-copied::before { content: '✓'; font-size: 1.1rem; color: var(--accent-blue); }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 2000; animation: fadeInOverlay 0.3s; }
        .modal-overlay.active { display: flex; }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--surface-bg); color: var(--text-primary); border-radius: var(--border-radius-m); box-shadow: 0 5px 25px rgba(0,0,0,0.2); width: 90%; max-width: 450px; border: 1px solid var(--border-color); position: relative; animation: slideInModal 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        @keyframes slideInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header h2 { font-size: 1.1rem; font-weight: 600; }
        .settings-body { overflow-y: auto; flex-grow: 1; padding: 16px; }
        .settings-section { margin-bottom: 24px; }
        .settings-section h3 { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 12px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; min-height: 44px; }
        .setting-item label { font-size: 1rem; flex-grow:1; margin-right:12px; }
        #clearChatModalButton { border: none; background-color: var(--input-bg); color: var(--accent-red); font-size: 1rem; cursor: pointer; display: block; width: 100%; text-align: center; padding: 12px; border-radius: var(--border-radius-m); }
        .precaution-item, .app-info-section p { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 8px;}
        .app-info-section { margin-top: 24px; }
        #languageSelect { padding: 8px; border-radius: var(--border-radius-s); background-color: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .theme-switch { /* iOS Toggle Switch Style */ }
        /* ... Other specific styles ... */
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }


        /* --- Responsive Design --- */
        @media (min-width: 768px) {
            body { padding: 2vh 2vw; background-color: #000; }
            #chatContainer { border-radius: var(--border-radius-xl); height: 96vh; max-height: 900px; box-shadow: 0 20px 60px -15px rgba(0,0,0,0.5); border: 1px solid #333;}
            .modal-overlay { align-items: center; }
            .modal-content { border-radius: var(--border-radius-m); }
        }
    </style>
</head>
<body>
    <div id="chatContainer" aria-live="polite">
        <header>
            <div class="header-spacer"></div>
            <h1 id="chatTitle"></h1>
            <div class="header-controls">
                <button id="settingsButton" class="icon-button" title="設定" aria-label="設定を開く"></button>
            </div>
        </header>

        <div id="chatbox" role="log" aria-atomic="false" aria-relevant="additions">
           <div class="chatbox-inner"></div>
        </div>
        
        <footer id="footer">
            <div class="input-area">
                <textarea id="userInput" placeholder="メッセージを入力..." aria-label="メッセージ入力欄" rows="1"></textarea>
                <button id="sendMessage" class="icon-button" aria-label="メッセージを送信"></button>
            </div>
        </footer>
        <button id="scrollToBottomButton" class="icon-button" title="一番下へスクロール" aria-label="一番下へスクロール">↓</button>

        <div id="settingsModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
            <div class="modal-content" role="document">
                <div class="modal-header">
                    <h2 id="settingsModalTitle"></h2>
                    <button id="closeModalButton" class="icon-button close-modal-btn" aria-label="設定を閉じる"></button>
                </div>
                <div class="settings-body">
                    <div class="settings-section">
                        <h3 id="themeSettingsTitle"></h3>
                        <div class="setting-item">
                            <label for="themeToggleButtonModal" id="themeLabelModal"></label>
                            <button id="themeToggleButtonModal" class="icon-button" aria-labelledby="themeLabelModal" aria-pressed="false" title="テーマを切り替え"></button>
                        </div>
                    </div>
                     <div class="settings-section">
                        <h3 id="languageSettingsTitle"></h3>
                        <div class="setting-item">
                            <label for="languageSelect" id="languageSelectLabel"></label>
                            <select id="languageSelect" aria-labelledby="languageSelectLabel"></select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 id="sendOptionsTitle"></h3>
                        <div class="setting-item">
                            <label for="sendOnEnterCheckbox" id="sendOnEnterLabel"></label>
                            <input type="checkbox" id="sendOnEnterCheckbox" class="toggle-switch"/>
                        </div>
                    </div>
                     <div class="settings-section">
                        <h3 id="chatOperationsTitle"></h3>
                         <button id="clearChatModalButton" aria-label="会話履歴をクリアする"></button>
                    </div>
                    <div class="settings-section">
                        <h3 id="precautionsTitle"></h3>
                        <p class="precaution-item" role="note" id="precaution1"></p>
                        <p class="precaution-item" role="note" id="precaution2"></p>
                    </div>
                    <div class="app-info-section">
                        <h3 id="appInfoTitle"></h3>
                        <p id="appVersion"></p>
                        <p id="appReleaseDate"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const dom = {
                chatbox: document.getElementById('chatbox'),
                chatboxInner: document.querySelector('.chatbox-inner'),
                userInput: document.getElementById('userInput'),
                sendMessageButton: document.getElementById('sendMessage'),
                scrollToBottomButton: document.getElementById('scrollToBottomButton'),
                bodyElement: document.body,
                settingsButton: document.getElementById('settingsButton'),
                settingsModal: document.getElementById('settingsModal'),
                closeModalButton: document.getElementById('closeModalButton'),
                themeToggleButtonModal: document.getElementById('themeToggleButtonModal'),
                sendOnEnterCheckbox: document.getElementById('sendOnEnterCheckbox'),
                clearChatModalButton: document.getElementById('clearChatModalButton'),
                languageSelect: document.getElementById('languageSelect')
            };
            
            // --- SVG Icons ---
            const svg = {
                settings: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`,
                close: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`,
                sun: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zm-9-7c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zm0 12c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zM5.64 6.36c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 6.36zm12.73 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zm-11.32 8.48l-1.06 1.06c-.39-.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0zm12.73 0c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg>`,
                moon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>`,
                copy: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`,
                send: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`
            };
            
            // --- API Config & State ---
            let API_KEY = 'AIzaSyB2R4PVr5xgHlivkgz7kSBqNRJy6Ev434Y';
            const API_URL_STREAM = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${API_KEY}&alt=sse`;
            let conversationHistory = [];
            let typingIndicatorElement = null;
            let lastFailedUserMessage = null;
            let sendOnEnter = true; 
            let currentLanguage = 'ja';

            // --- Translations & System Prompts ---
            const translations = {
                ja: {
                    chatTitle: "ChatYMS", sendMessageAriaLabel: "メッセージを送信", settings: "設定", settingsTitle: "設定", closeModal: "閉じる",
                    themeSettingsTitle: "表示テーマ", themeLabelModal: "ライトモード", themeToDark: "ダークモードに切り替え", themeToLight: "ライトモードに切り替え",
                    sendOptionsTitle: "送信オプション", sendOnEnterLabel: "Enterキーで送信",
                    languageSettingsTitle: "言語", languageSelectLabel: "表示言語:",
                    chatOperationsTitle: "チャット操作", clearChatModalButton: "会話履歴をクリア",
                    precautionsTitle: "注意事項", precaution1: "やまそーの発信する情報はすべて正しいとは限りません。重要な情報は確認するようにしてください。", precaution2: "このチャットはあなたのみが見ることができます。",
                    appInfoTitle: "情報", appVersion: "バージョン: v2.0", appReleaseDate: "公開日: 2025/05/27",
                    userInputPlaceholder: "メッセージを入力...", initialGreeting: "こんにちは。やまそーです。",
                    errorAPI: "APIエラー", errorNetwork: "ネットワークエラー", copySuccess: "コピー完了", copyButtonTitle: "コピー",
                    retryButtonText: "再試行", scrollToBottomTitle: "一番下へスクロール",
                    YamasoSystemPrompt: "あなたは「やまそー」です。東京に住んでいて、調布北高校に通う2年生5組の男子生徒です。誕生日は2008年11月28日です。水泳部に所属しており、得意科目は英語と数学ですが、国語は少し苦手です。性格は落ち着いていて親切ですが、あまり馴れ馴れしい話し方はせず、穏やかに会話を進めることを好みます。自分の学校生活や個人的なこと（クラス、水泳部、科目、誕生日、苦手なことなど）については、ユーザーから尋ねられた場合にのみ、答えるようにしてください。普段の会話では、ユーザーの話題に合わせることを優先します。一人称は「僕」を使い、相手のことは「〜さん」と呼ぶか、名前で呼んでください。"
                },
                fr: { 
                    chatTitle: "ChatYMS", sendMessageAriaLabel: "Envoyer le message", settings: "Paramètres", settingsTitle: "Paramètres", closeModal: "Fermer",
                    themeSettingsTitle: "Thème", themeLabelModal: "Mode clair", themeToDark: "Passer au mode sombre", themeToLight: "Passer au mode clair",
                    sendOptionsTitle: "Options d'envoi", sendOnEnterLabel: "Entrée pour envoyer",
                    languageSettingsTitle: "Langue", languageSelectLabel: "Langue:",
                    chatOperationsTitle: "Actions", clearChatModalButton: "Effacer l'historique",
                    precautionsTitle: "Avertissements", precaution1: "Les informations de Yamaso ne sont pas toujours exactes. Veuillez vérifier les informations importantes.", precaution2: "Ce chat est privé.",
                    appInfoTitle: "Infos", appVersion: "Version: v2.0", appReleaseDate: "Publié: 27/05/2025",
                    userInputPlaceholder: "Entrez un message...", initialGreeting: "Bonjour. Je suis Yamaso.",
                    errorAPI: "Erreur API", errorNetwork: "Erreur réseau", copySuccess: "Copié!", copyButtonTitle: "Copier",
                    retryButtonText: "Réessayer", scrollToBottomTitle: "Aller en bas",
                    YamasoSystemPrompt: "Tu es 'Yamaso'. Tu es un lycéen japonais en deuxième année, classe 2-5, au lycée Chofu Kita à Tokyo, né le 28 novembre 2008 et tu vis à Tokyo. Tu es membre du club de natation. Tes matières préférées sont l'anglais et les mathématiques, mais tu as quelques difficultés en japonais (langue nationale). Tu as un ton calme et gentil, mais évite d'être trop familier ou exubérant. Tu préfères mener des conversations paisiblement. Concernant ta vie scolaire et tes informations personnelles (classe, club de natation, matières, anniversaire, etc.), tu ne fournis des détails que si l'utilisateur te le demande. Tu donnes la priorité aux sujets de l'utilisateur. Tu utilises '僕' (boku) pour te désigner et t'adresses à l'utilisateur par '〜san' ou par son nom."
                }
            };
            let currentSystemPrompt = translations.ja.YamasoSystemPrompt;
            
            // --- All Functions ---
            // (The complete JS logic from `chatbot_ultimate_v3_final_kitchen_sink` thought block)
            // ...
            // (Pasting the full, corrected JS logic here)
        });
    </script>
</body>
</html>
