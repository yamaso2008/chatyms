<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatYMS - v1.7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* :root CSS変数は前回のものをベースに、不要なものを削除、必要なものを調整 */
        :root {
            --font-primary: 'Inter', sans-serif;

            /* Refined Dark Mode Variables */
            --dm-bg-gradient-start: #0d1117; --dm-bg-gradient-mid1: #161b22; --dm-bg-gradient-mid2: #0d1117; --dm-bg-gradient-end: #010409;
            --dm-glass-bg: rgba(22, 27, 34, 0.78); --dm-glass-border: rgba(72, 86, 101, 0.4); --dm-glass-shadow: rgba(0, 0, 0, 0.5); --dm-highlight-glow: rgba(100, 150, 255, 0.12);
            --dm-text-primary: #c9d1d9; --dm-text-secondary: #8b949e; --dm-text-input: #e6edf3; --dm-header-text: #f0f6fc;
            --dm-accent-glow: rgba(88, 166, 255, 0.65);
            --dm-user-bubble-bg: linear-gradient(135deg, rgba(56, 139, 253, 0.35) 0%, rgba(31, 111, 235, 0.45) 100%); --dm-user-bubble-border: rgba(88, 166, 253, 0.5); --dm-user-bubble-text: #f0f6fc;
            --dm-bot-bubble-bg: rgba(45, 53, 64, 0.8); --dm-bot-bubble-border: rgba(72, 86, 101, 0.6);
            --dm-typing-dot-color: var(--dm-text-secondary);
            --dm-button-bg: rgba(56, 139, 253, 0.3); --dm-button-hover-bg: rgba(56, 139, 253, 0.45); --dm-button-text: #58a6ff; --dm-button-border: rgba(88, 166, 253, 0.6);
            --dm-input-bg: rgba(13, 17, 23, 0.6); --dm-input-focus-bg: rgba(1, 4, 9, 0.8); --dm-footer-header-bg: rgba(13, 17, 23, 0.75);
            --dm-scrollbar-track: rgba(13,17,23,0.4); --dm-scrollbar-thumb: rgba(56,139,253,0.5); --dm-scrollbar-thumb-hover: rgba(56,139,253,0.7);
            --dm-markdown-code-bg: rgba(100,110,130,0.3); --dm-markdown-pre-bg: rgba(1,4,9,0.6); --dm-markdown-border: rgba(72,86,101,0.5);
            --dm-modal-bg: rgba(13, 17, 23, 0.97); --dm-modal-content-bg: rgba(22, 27, 34, 0.92); --dm-modal-border: var(--dm-glass-border);
            --dm-error-bubble-bg: rgba(200, 50, 50, 0.3); --dm-error-text: #ffaaaa; --dm-error-border: rgba(200, 50, 50, 0.6);
            --dm-select-bg: var(--dm-input-bg); --dm-select-text: var(--dm-text-input); --dm-select-border: var(--dm-glass-border);


            /* Refined Light Mode Variables */
            --lm-bg-gradient-start: #f0f2f5; --lm-bg-gradient-mid1: #f8f9fa; --lm-bg-gradient-mid2: #f0f2f5; --lm-bg-gradient-end: #e9ecef;
            --lm-glass-bg: rgba(255, 255, 255, 0.7); --lm-glass-border: rgba(0, 0, 0, 0.12); --lm-glass-shadow: rgba(150, 150, 180, 0.22); --lm-highlight-glow: rgba(0, 123, 255, 0.1);
            --lm-text-primary: #212529; --lm-text-secondary: #495057; --lm-text-input: #000000; --lm-header-text: #000000;
            --lm-accent-glow: rgba(0, 123, 255, 0.6);
            --lm-user-bubble-bg: linear-gradient(135deg, rgba(0, 123, 255, 0.8) 0%, rgba(0, 100, 220, 0.9) 100%); --lm-user-bubble-border: transparent; --lm-user-bubble-text: #ffffff;
            --lm-bot-bubble-bg: rgba(233, 236, 239, 0.98); --lm-bot-bubble-border: rgba(200,200,200,0.7);
            --lm-typing-dot-color: var(--lm-text-secondary);
            --lm-button-bg: rgba(0, 123, 255, 0.25); --lm-button-hover-bg: rgba(0, 123, 255, 0.35); --lm-button-text: #007bff; --lm-button-border: rgba(0, 123, 255, 0.5);
            --lm-input-bg: rgba(255, 255, 255, 0.8); --lm-input-focus-bg: rgba(255, 255, 255, 0.98); --lm-footer-header-bg: rgba(255,255,255,0.6);
            --lm-scrollbar-track: rgba(0,0,0,0.05); --lm-scrollbar-thumb: rgba(0,0,0,0.3); --lm-scrollbar-thumb-hover: rgba(0,0,0,0.4);
            --lm-markdown-code-bg: #e9ecef; --lm-markdown-pre-bg: #f8f9fa; --lm-markdown-border: #ced4da;
            --lm-modal-bg: rgba(248, 249, 250, 0.97); --lm-modal-content-bg: rgba(255,255,255, 0.98); --lm-modal-border: #b8c2cc;
            --lm-error-bubble-bg: rgba(255, 200, 200, 0.8); --lm-error-text: #721c24; --lm-error-border: rgba(200, 50, 50, 0.6);
            --lm-select-bg: var(--lm-input-bg); --lm-select-text: var(--lm-text-input); --lm-select-border: var(--lm-glass-border);


            /* Mapped Variables (Defaults to Dark Mode) */
            --current-bg-gradient-start: var(--dm-bg-gradient-start); /* ... (all mapped variables) ... */
            --current-bg-gradient-mid1: var(--dm-bg-gradient-mid1); --current-bg-gradient-mid2: var(--dm-bg-gradient-mid2); --current-bg-gradient-end: var(--dm-bg-gradient-end);
            --current-glass-bg: var(--dm-glass-bg); --current-glass-border: var(--dm-glass-border); --current-glass-shadow: var(--dm-glass-shadow); --current-highlight-glow: var(--dm-highlight-glow);
            --current-text-primary: var(--dm-text-primary); --current-text-secondary: var(--dm-text-secondary); --current-text-input: var(--dm-text-input); --current-header-text-color: var(--dm-header-text);
            --current-accent-glow: var(--dm-accent-glow);
            --current-user-bubble-bg: var(--dm-user-bubble-bg); --current-user-bubble-border: var(--dm-user-bubble-border); --current-user-bubble-text-color: var(--dm-user-bubble-text);
            --current-bot-bubble-bg: var(--dm-bot-bubble-bg); --current-bot-bubble-border: var(--dm-bot-bubble-border);
            --current-typing-dot-color: var(--dm-typing-dot-color);
            --current-button-bg: var(--dm-button-bg); --current-button-hover-bg: var(--dm-button-hover-bg); --current-button-text-color: var(--dm-button-text); --current-button-border: var(--dm-button-border);
            --current-input-bg: var(--dm-input-bg); --current-input-focus-bg: var(--dm-input-focus-bg); --current-footer-header-bg-color: var(--dm-footer-header-bg);
            --current-scrollbar-track-bg: var(--dm-scrollbar-track); --current-scrollbar-thumb-bg: var(--dm-scrollbar-thumb); --current-scrollbar-thumb-hover-bg: var(--dm-scrollbar-thumb-hover);
            --current-markdown-code-bg-color: var(--dm-markdown-code-bg); --current-markdown-pre-bg-color: var(--dm-markdown-pre-bg); --current-markdown-border-color: var(--dm-markdown-border);
            --current-modal-bg-color: var(--dm-modal-bg); --current-modal-content-bg: var(--dm-modal-content-bg); --current-modal-border-color: var(--dm-modal-border);
            --current-error-bubble-bg-color: var(--dm-error-bubble-bg); --current-error-text-color: var(--dm-error-text); --current-error-border-color: var(--dm-error-border);
            --current-select-bg: var(--dm-select-bg); --current-select-text: var(--dm-select-text); --current-select-border: var(--dm-select-border);


            --border-radius-main: 24px; --border-radius-bubble: 20px; --border-radius-button: 14px;
            --font-primary: 'Inter', sans-serif;
        }
        body.light-mode { /* Mapped Light mode variables */
            --current-bg-gradient-start: var(--lm-bg-gradient-start); /* ... (all lm variables) ... */
            --current-bg-gradient-mid1: var(--lm-bg-gradient-mid1); --current-bg-gradient-mid2: var(--lm-bg-gradient-mid2); --current-bg-gradient-end: var(--lm-bg-gradient-end);
            --current-glass-bg: var(--lm-glass-bg); --current-glass-border: var(--lm-glass-border); --current-glass-shadow: var(--lm-glass-shadow); --current-highlight-glow: var(--lm-highlight-glow);
            --current-text-primary: var(--lm-text-primary); --current-text-secondary: var(--lm-text-secondary); --current-text-input: var(--lm-text-input); --current-header-text-color: var(--lm-header-text);
            --current-accent-glow: var(--lm-accent-glow);
            --current-user-bubble-bg: var(--lm-user-bubble-bg); --current-user-bubble-border: var(--lm-user-bubble-border); --current-user-bubble-text-color: var(--lm-user-bubble-text);
            --current-bot-bubble-bg: var(--lm-bot-bubble-bg); --current-bot-bubble-border: var(--lm-bot-bubble-border);
            --current-typing-dot-color: var(--lm-typing-dot-color);
            --current-button-bg: var(--lm-button-bg); --current-button-hover-bg: var(--lm-button-hover-bg); --current-button-text-color: var(--lm-button-text); --current-button-border: var(--lm-button-border);
            --current-input-bg: var(--lm-input-bg); --current-input-focus-bg: var(--lm-input-focus-bg); --current-footer-header-bg-color: var(--lm-footer-header-bg);
            --current-scrollbar-track-bg: var(--lm-scrollbar-track); --current-scrollbar-thumb-bg: var(--lm-scrollbar-thumb); --current-scrollbar-thumb-hover-bg: var(--lm-scrollbar-thumb-hover);
            --current-markdown-code-bg-color: var(--lm-markdown-code-bg); --current-markdown-pre-bg-color: var(--lm-markdown-pre-bg); --current-markdown-border-color: var(--lm-markdown-border);
            --current-modal-bg-color: var(--lm-modal-bg); --current-modal-content-bg: var(--lm-modal-content-bg); --current-modal-border-color: var(--lm-modal-border);
            --current-error-bubble-bg-color: var(--lm-error-bubble-bg); --current-error-text-color: var(--lm-error-text); --current-error-border-color: var(--lm-error-border);
            --current-select-bg: var(--lm-select-bg); --current-select-text: var(--lm-select-text); --current-select-border: var(--lm-select-border);
        }

        /* General, Responsive, Feature styles (many are similar to previous but use new --current- variables and refined values for the new aesthetic) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary);
            background: linear-gradient(-45deg, var(--current-bg-gradient-start), var(--current-bg-gradient-mid1), var(--current-bg-gradient-mid2), var(--current-bg-gradient-end));
            background-size: 200% 200%; animation: gradientBG 35s ease infinite;
            color: var(--current-text-primary); display: flex; justify-content: center; align-items: center;
            min-height: 100vh; min-height: 100dvh; /* Dynamic viewport height */
            padding: 0; overflow: hidden; 
            transition: background 0.7s cubic-bezier(0.4, 0, 0.2, 1), color 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        #chatContainer {
            width: 100%; max-width: 800px; /* Wider on desktop */
            height: 100%; /* Full height on mobile */
            background: var(--current-glass-bg);
            border-radius: var(--border-radius-main);
            border: 1px solid var(--current-glass-border);
            box-shadow: 0 20px 70px -10px var(--current-glass-shadow), 0 0 0 1px var(--current-glass-border) inset;
            backdrop-filter: blur(22px); -webkit-backdrop-filter: blur(22px);
            display: flex; flex-direction: column; overflow: hidden;
            transition: background 0.6s ease, border 0.6s ease, box-shadow 0.6s ease;
            position: relative;
        }
        #chatContainer::before { /* Enhanced Glow */
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: calc(var(--border-radius-main) + 2px);
            box-shadow: 0 0 50px 10px var(--current-highlight-glow);
            z-index: -1; opacity: 0.8; pointer-events: none;
        }


        header {
            padding: 0.8rem 1.3rem; background: var(--current-footer-header-bg-color);
            border-bottom: 1px solid var(--current-glass-border); display: flex;
            justify-content: space-between; align-items: center; flex-shrink: 0;
            transition: background 0.5s ease, border-bottom 0.5s ease;
            position: relative; z-index: 10; 
        }
        header h1 {
            font-weight: 700; font-size: 1.5rem; color: var(--current-header-text-color);
            text-shadow: 0 0 12px var(--current-accent-glow); transition: color 0.5s ease, text-shadow 0.5s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            flex-grow: 1; text-align: center;
        }
        .header-controls { display: flex; align-items: center; gap: 0.3rem; } /* Tighter for more icons */

        #chatbox {
            flex-grow: 1; padding: 1.2rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 1rem; /* More space between messages */
            position: relative; 
        }
        /* ... scrollbar, message styles ... */
        #chatbox::-webkit-scrollbar { width: 8px; } #chatbox::-webkit-scrollbar-track { background: var(--current-scrollbar-track-bg); border-radius: 10px; } #chatbox::-webkit-scrollbar-thumb { background: var(--current-scrollbar-thumb-bg); border-radius: 10px; border: 2px solid transparent; background-clip: content-box;} #chatbox::-webkit-scrollbar-thumb:hover { background: var(--current-scrollbar-thumb-hover-bg); }
        .message-container { display: flex; flex-direction: column; margin-bottom: 0.6rem; animation: fadeInSlideUp 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .message-content-wrapper { display: flex; align-items: flex-end; width: 100%; }
        .message-container.user-message .message-content-wrapper { justify-content: flex-end; } .message-container.bot-message .message-content-wrapper { justify-content: flex-start; }
        .message-bubble {
            padding: 0.8rem 1.2rem; border-radius: var(--border-radius-bubble);
            max-width: 85%; line-height: 1.65;
            box-shadow: 0 5px 20px -5px rgba(0,0,0,0.2), 0 3px 8px -4px rgba(0,0,0,0.15); 
            transition: transform 0.2s ease, background 0.5s ease, color 0.5s ease, border 0.5s ease;
            display: inline-block; text-align: left; overflow-wrap: break-word;
            border: 1px solid var(--current-glass-border); /* All bubbles have subtle border */
            background: var(--current-glass-bg); /* All bubbles are glassy */
        }
        .user-message .message-bubble { background: var(--current-user-bubble-bg); color: var(--current-user-bubble-text-color); border-color: var(--current-user-bubble-border); border-radius: var(--border-radius-bubble) 0px var(--border-radius-bubble) var(--border-radius-bubble) ; } 
        .message-container.user-message { align-items: flex-end; }
        .bot-message .message-bubble { background: var(--current-bot-bubble-bg); color: var(--current-text-primary); border-color: var(--current-bot-bubble-border); border-radius: 0px var(--border-radius-bubble) var(--border-radius-bubble) var(--border-radius-bubble); }
        .message-container.bot-message { align-items: flex-start; }
        .message-bubble.error-message { background: var(--current-error-bubble-bg-color); color: var(--current-error-text-color); border: 1px solid var(--current-error-border-color); }
        .timestamp { font-size: 0.6rem; color: var(--current-text-secondary); margin-top: 0.3rem; padding: 0 0.5rem; transition: color 0.5s ease; opacity: 0.8; }
        .message-container.user-message .timestamp { align-self: flex-end; } .message-container.bot-message .timestamp { align-self: flex-start; }
        .copy-btn { background: none; border: none; color: var(--current-text-secondary); cursor: pointer; font-size: 0; padding:4px; margin-left: 0.6rem; opacity: 0.6; transition: opacity 0.2s ease, color 0.5s ease, transform 0.2s ease; width: 30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius: 50%; }
        .copy-btn svg { width: 15px; height: 15px; fill: currentColor; }
        .copy-btn:hover { opacity: 1; background-color: rgba(120,120,150,0.1); transform: scale(1.1);} 
        .copy-btn-copied svg { fill: var(--current-button-text-color) !important; }
        .copy-btn-copied::after { content: attr(data-copied-text); font-size: 0.6rem; margin-left: 4px; color: var(--current-button-text-color);}

        .typing-indicator-bubble { display: flex; align-items: center; background: var(--current-bot-bubble-bg) !important; padding: 0.8rem 1rem !important; border-color: var(--current-bot-bubble-border) !important;}
        .typing-dot { width: 8px; height: 8px; background-color: var(--current-typing-dot-color); border-radius: 50%; margin: 0 3px; animation: typingDots 1.4s infinite ease-in-out both; transition: background-color 0.5s ease; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingDots { 0%, 80%, 100% { transform: scale(0.5); opacity: 0.4; } 40% { transform: scale(1.0); opacity: 1; } }
        .message-container.bot-message.typing .timestamp, .message-container.bot-message.typing .copy-btn { display: none; }
        /* Markdown Styles, etc. */
        .message-bubble pre { background-color: var(--current-markdown-pre-bg-color); border: 1px solid var(--current-markdown-border-color); border-radius: 8px; padding: 0.8rem; overflow-x: auto; font-size: 0.8rem; margin: 0.6rem 0; transition: background-color 0.5s ease, border 0.5s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1) inset; }
        .message-bubble code { background-color: var(--current-markdown-code-bg-color); padding: 3px 6px; border-radius: 5px; font-size: 0.85em; transition: background-color 0.5s ease; }
        .message-bubble pre code { background-color: transparent; padding: 0; font-size: inherit; }
        .message-bubble ul, .message-bubble ol { margin-left: 1.5rem; padding-left: 0.5rem; } .message-bubble li { margin-bottom: 0.3rem; }
        .message-bubble a { color: var(--current-button-text-color); text-decoration: none; font-weight: 500;} .message-bubble a:hover { text-decoration: underline; }
        .message-bubble blockquote { border-left: 3px solid var(--current-glass-border); padding-left: 0.8rem; margin: 0.5rem 0; color: var(--current-text-secondary); font-style: italic; }


        footer {
            padding: 0.8rem 1.2rem; border-top: 1px solid var(--current-glass-border);
            background: var(--current-footer-header-bg-color); display: flex;
            flex-direction: column; gap: 0.5rem; transition: background 0.5s ease, border-top 0.5s ease;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        .input-area { display: flex; gap: 0.8rem; align-items: center;} /* Mic button removed */
        #userInput {
            flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--current-glass-border);
            border-radius: var(--border-radius-button); background: var(--current-input-bg);
            color: var(--current-text-input); font-size: 1rem; outline: none;
            transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
        }
        #userInput:focus { border-color: var(--current-accent-glow); box-shadow: 0 0 15px var(--current-accent-glow), 0 2px 6px rgba(0,0,0,0.15) inset; background: var(--current-input-focus-bg); }
        #sendMessage { /* Main send button */
            padding: 0.8rem 1.4rem; border: 1px solid var(--current-button-border);
            border-radius: var(--border-radius-button); background: var(--current-button-bg);
            color: var(--current-button-text-color); font-size: 1rem; font-weight: 600;
            cursor: pointer; outline: none; transition: all 0.3s ease;
            box-shadow: 0 4px 10px -2px rgba(0,0,0,0.3);
        }
        body.light-mode #sendMessage { box-shadow: 0 4px 10px -2px rgba(0,0,0,0.18); }
        #sendMessage:hover { background: var(--current-button-hover-bg); box-shadow: 0 0 15px var(--current-accent-glow), 0 4px 10px -2px rgba(0,0,0,0.3); transform: translateY(-2px); }
        #sendMessage:active { transform: translateY(0px) scale(0.97); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Icon Button Base Styles (Speaker, Settings, Close Modal, new Theme Toggle) */
        .icon-button {
            background: transparent; border: 1px solid transparent; 
            color: var(--current-text-secondary); padding: 0.5rem; border-radius: 50%;
            width: 42px; height: 42px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s ease-out;
        }
        .icon-button:hover { color: var(--current-text-primary); background-color: rgba(120,120,150,0.2); transform: scale(1.08); }
        .icon-button:active { transform: scale(0.92); }
        .icon-button svg { width: 20px; height: 20px; fill: currentColor; }
        
        /* Scroll to Bottom Button */
        #scrollToBottomButton { position: absolute; bottom: calc(env(safe-area-inset-bottom, 0px) + 20px + 70px); /* Adjusted for footer */ right: 20px; background-color: var(--current-button-bg); color: var(--current-button-text-color); border: 1px solid var(--current-button-border); border-radius: 50%; width: 48px; height: 48px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100; display: none; transition: background-color 0.3s, opacity 0.3s, transform 0.2s ease; opacity: 0.9; }
        #scrollToBottomButton:hover { opacity: 1; transform: scale(1.1) translateY(-2px); box-shadow: 0 7px 18px rgba(0,0,0,0.38); }

        /* Retry Button */
        .retry-btn { margin-left: 10px; padding: 5px 12px; font-size: 0.75rem; background-color: var(--current-button-bg); color: var(--current-button-text-color); border: 1px solid var(--current-button-border); border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; }
        .retry-btn:hover { background-color: var(--current-button-hover-bg); }

        /* Settings Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background-color: var(--current-modal-content-bg); 
            color: var(--current-text-primary); padding: 2rem; border-radius: var(--border-radius-main);
            box-shadow: 0 12px 60px -15px var(--current-glass-shadow); width: 90%; max-width: 520px;
            border: 1px solid var(--current-modal-border-color); position: relative;
            animation: slideInModal 0.45s cubic-bezier(0.25, 0.1, 0.25, 1);
            transition: background-color 0.5s, color 0.5s, border 0.5s;
            max-height: 85vh; /* Crucial for scroll */
            display: flex; flex-direction: column; /* Crucial for scroll */
        }
        @keyframes slideInModal { from { opacity: 0; transform: translateY(-30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.8rem; padding-bottom: 1rem; border-bottom: 1px solid var(--current-glass-border); flex-shrink: 0; }
        .modal-header h2 { font-size: 1.6rem; font-weight: 700; color: var(--current-header-text-color); }
        .close-modal-btn { /* Uses .icon-button */ margin-left:auto; }
        .settings-body { /* This part will scroll */
            overflow-y: auto; flex-grow: 1; 
            padding-right: 10px; /* Space for scrollbar */
            margin-right: -10px; /* Compensate for padding */
        }
        .settings-section { margin-bottom: 2rem; }
        .settings-section:last-child { margin-bottom: 0.5rem; }
        .settings-section h3 { font-size: 1.15rem; font-weight: 600; color: var(--current-text-primary); margin-bottom: 1rem; padding-bottom: 0.6rem; border-bottom: 1px solid var(--current-glass-border); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; }
        .setting-item label { font-size: 0.95rem; color: var(--current-text-secondary); flex-grow:1; margin-right:1rem; }
        #languageSelect {
            padding: 0.5rem 0.8rem; border-radius: var(--border-radius-button);
            background-color: var(--current-select-bg); color: var(--current-select-text);
            border: 1px solid var(--current-select-border); font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        #languageSelect:focus { border-color: var(--current-accent-glow); box-shadow: 0 0 8px var(--current-accent-glow); }

        #clearChatModalButton {
            padding: 0.7rem 1.3rem; border: 1px solid var(--current-button-border); border-radius: var(--border-radius-button);
            background: var(--current-button-bg); color: var(--current-button-text-color); font-size: 0.95rem; font-weight: 500;
            cursor: pointer; transition: all 0.3s ease; display: inline-block; margin-top: 0.5rem;
        }
        #clearChatModalButton:hover { background: var(--current-button-hover-bg); box-shadow: 0 0 10px var(--current-accent-glow); }
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 28px; flex-shrink:0; } /* Re-using from before */
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #5a6978; transition: .4s; border-radius: 28px; }
        body.light-mode .slider { background-color: #ced4da; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2);}
        input:checked + .slider { background-color: var(--current-button-bg); }
        input:focus + .slider { box-shadow: 0 0 3px var(--current-button-bg); }
        input:checked + .slider:before { transform: translateX(22px); }
        .app-info-section p { font-size: 0.8rem; color: var(--current-text-secondary); margin-bottom: 0.3rem; text-align:left; }
        .precaution-item { font-size: 0.85rem; color: var(--current-text-secondary); margin-bottom: 0.5rem; line-height: 1.5;}


        /* Responsive Adjustments for refined design */
        @media (max-width: 768px) { /* Adjusted breakpoint */
            html { font-size: 15.5px; } 
            #chatContainer { border-radius: 0; max-height:none; height: 100dvh; }
            #chatContainer::before { display: none; }
            header { padding: 0.6rem 0.9rem; } header h1 { font-size: 1.3rem; } .header-controls { gap: 0.2rem; }
            .header-controls .icon-button { width: 38px; height: 38px; } .header-controls .icon-button svg { width: 18px; height: 18px; }
            #chatbox { padding: 0.9rem; } .message-bubble { max-width: 90%; }
            footer { padding: 0.7rem 0.9rem; } .input-area { gap: 0.6rem; }
            #userInput, #sendMessage { font-size: 0.95rem; padding: 0.7rem 0.9rem; }
            #sendMessage { padding: 0.7rem 1.1rem; }
            #scrollToBottomButton { width: 42px; height: 42px; font-size: 1.3rem; bottom: calc(env(safe-area-inset-bottom, 0px) + 15px + 65px); right: 15px; }
            .modal-content { padding: 1.5rem; max-width: 95%; max-height: 90vh;}
            .modal-header h2 { font-size: 1.4rem; }
            .setting-item label, #clearChatModalButton, #languageSelect { font-size: 0.9rem; }
        }
        @media (max-width: 480px) { /* Smaller mobile */
            header h1 { font-size: 1.1rem; }
            .header-controls .icon-button { width: 36px; height: 36px; } .header-controls .icon-button svg { width: 17px; height: 17px; }
            #chatbox { padding: 0.7rem; }
            footer { padding: 0.6rem; }
            #userInput, #sendMessage { font-size: 0.9rem; }
            .modal-header h2 { font-size: 1.2rem; }
            .setting-item label, #clearChatModalButton, #languageSelect { font-size: 0.85rem; }
            .theme-switch { width: 46px; height: 26px; } .slider:before { height: 20px; width: 20px; } input:checked + .slider:before { transform: translateX(20px); }
            .app-info-section p, .precaution-item { font-size: 0.75rem; }
        }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

    </style>
</head>
<body>
    <div id="chatContainer" aria-live="polite">
        <header>
            <h1 id="chatTitle">ChatYMS</h1>
            <div class="header-controls">
                <button id="settingsButton" class="icon-button" title="設定" aria-label="設定を開く">
                    </button>
            </div>
        </header>

        <div id="chatbox" role="log" aria-atomic="false" aria-relevant="additions">
            </div>
        
        <footer>
            <div class="input-area">
                <input type="text" id="userInput" placeholder="メッセージを入力..." aria-label="メッセージ入力欄">
                <button id="sendMessage" aria-label="メッセージを送信">送信</button>
            </div>
        </footer>
        <button id="scrollToBottomButton" title="一番下へスクロール" aria-label="一番下へスクロール">↓</button>

        <div id="settingsModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
            <div class="modal-content" role="document">
                <div class="modal-header">
                    <h2 id="settingsModalTitle">設定</h2>
                    <button id="closeModalButton" class="icon-button close-modal-btn" aria-label="設定を閉じる">
                        </button>
                </div>
                <div class="settings-body">
                    <div class="settings-section">
                        <h3 id="themeSettingsTitle">表示テーマ</h3>
                        <div class="setting-item">
                            <label for="themeToggleButtonModal" id="themeLabelModal">ダークモード / ライトモード</label>
                            <button id="themeToggleButtonModal" class="icon-button" aria-labelledby="themeLabelModal" aria-pressed="false" title="テーマを切り替え">
                                </button>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 id="sendOptionsTitle">送信オプション</h3>
                        <div class="setting-item">
                            <label for="sendOnEnterCheckbox" id="sendOnEnterLabel">Enterキーで送信 (Shift+Enterで改行)</label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch" for="sendOnEnterCheckbox" aria-label="Enterキーで送信する機能のオンオフ">
                                    <input type="checkbox" id="sendOnEnterCheckbox" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                     <div class="settings-section">
                        <h3 id="languageSettingsTitle">言語 / Language</h3>
                        <div class="setting-item">
                            <label for="languageSelect" id="languageSelectLabel">表示言語:</label>
                            <select id="languageSelect" aria-labelledby="languageSelectLabel">
                                <option value="ja">日本語</option>
                                <option value="fr">Français</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 id="chatOperationsTitle">チャット操作</h3>
                         <button id="clearChatModalButton" aria-label="会話履歴をクリアする">会話履歴をクリア</button>
                    </div>
                    <div class="settings-section">
                        <h3 id="precautionsTitle">注意事項</h3>
                        <p class="precaution-item" role="note" id="precaution1"></p>
                        <p class="precaution-item" role="note" id="precaution2"></p>
                    </div>
                    <div class="settings-section app-info-section">
                        <h3 id="appInfoTitle">情報</h3>
                        <p class="app-version-info" id="appVersion"></p>
                        <p class="app-release-date" id="appReleaseDate"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('userInput');
        const sendMessageButton = document.getElementById('sendMessage');
        // Mic & Speaker buttons removed
        const scrollToBottomButton = document.getElementById('scrollToBottomButton');
        const bodyElement = document.body;
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const themeToggleButtonModal = document.getElementById('themeToggleButtonModal');
        const sendOnEnterCheckbox = document.getElementById('sendOnEnterCheckbox');
        const clearChatModalButton = document.getElementById('clearChatModalButton');
        const languageSelect = document.getElementById('languageSelect');

        // --- SVG Icons ---
        const settingsSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`;
        const closeModalSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`;
        const sunSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zm-9-7c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zm0 12c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zM5.64 6.36c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 6.36zm12.73 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0zM5.64 17.64l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0zm12.73 0c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41l-1.06 1.06c-.39.39-1.02-.39-1.41 0s-.39-1.02 0-1.41l1.06-1.06z"/></svg>`;
        const moonSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>`;
        const copySVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
        
        // --- API Config & State Variables ---
        const API_KEY = 'AIzaSyB2R4PVr5xgHlivkgz7kSBqNRJy6Ev434Y';
        const API_URL_STREAM = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${API_KEY}&alt=sse`;
        let conversationHistory = [];
        let typingIndicatorElement = null;
        
        const translations = { // (Translations object from previous)
            ja: {
                chatTitle: "ChatYMS", sendMessage: "送信", settings: "設定", settingsTitle: "設定", closeModal: "設定を閉じる",
                themeSettingsTitle: "表示テーマ", themeLabelModal: "ダークモード / ライトモード", themeToDark: "ダークモードに切り替え", themeToLight: "ライトモードに切り替え",
                sendOptionsTitle: "送信オプション", sendOnEnterLabel: "Enterキーで送信 (Shift+Enterで改行)",
                languageSettingsTitle: "言語 / Language", languageSelectLabel: "表示言語:",
                chatOperationsTitle: "チャット操作", clearChatModalButton: "会話履歴をクリア",
                precautionsTitle: "注意事項", precaution1: "やまそーの発信する情報はすべて正しいとは限りません。重要な情報は確認するようにしてください。", precaution2: "このチャットはあなたのみが見ることができます。",
                appInfoTitle: "情報", appVersion: "バージョン: v1.7", appReleaseDate: "公開日: 2025/05/27",
                userInputPlaceholder: "メッセージを入力...", initialGreeting: "こんにちは。やまそーです。",
                typingIndicatorText: "考え中です...", errorNetwork: "ネットワークエラーが発生しました。", errorAPI: "APIエラー", errorUnknown: "不明なエラー", errorStream: "ネットワークまたはストリームエラー", errorEmptyResponse: "AIからの応答が空でした。",
                copySuccess: "コピー済!", copyButtonTitle: "メッセージをコピー",
                retryButtonText: "再試行", retryButtonTitle: "最後に失敗したメッセージを再送信します",
                scrollToBottomTitle: "一番下へスクロール",
                YamasoSystemPrompt: "あなたは「やまそー」です。東京に住んでいて、調布北高校に通う2年生5組の男子生徒です。誕生日は2008年11月28日です。水泳部に所属しており、得意科目は英語と数学ですが、国語は少し苦手です。性格は落ち着いていて親切ですが、あまり馴れ馴れしい話し方はせず、穏やかに会話を進めることを好みます。自分の学校生活や個人的なこと（クラス、水泳部、科目、誕生日、苦手なことなど）については、ユーザーから尋ねられた場合にのみ、答えるようにしてください。普段の会話では、ユーザーの話題に合わせることを優先します。一人称は「僕」を使い、相手のことは「〜さん」と呼ぶか、名前で呼んでください。"
            },
            fr: { // (French translations from previous, shortened for brevity here - will be in actual code)
                chatTitle: "ChatYMS", sendMessage: "Envoyer", settings: "Paramètres", settingsTitle: "Paramètres", closeModal: "Fermer",
                themeSettingsTitle: "Thème", themeLabelModal: "Sombre / Clair", themeToDark: "Mode sombre", themeToLight: "Mode clair",
                sendOptionsTitle: "Options d'envoi", sendOnEnterLabel: "Entrée pour envoyer (Maj+Entrée pour ligne)",
                languageSettingsTitle: "Langue", languageSelectLabel: "Langue:",
                chatOperationsTitle: "Actions", clearChatModalButton: "Effacer l'historique",
                precautionsTitle: "Précautions", precaution1: "Les informations de Yamaso ne sont pas toujours exactes. Vérifiez les informations importantes.", precaution2: "Ce chat est privé.",
                appInfoTitle: "Infos", appVersion: "Version: v1.7", appReleaseDate: "Publié: 27/05/2025",
                userInputPlaceholder: "Entrez un message...", initialGreeting: "Bonjour. Je suis Yamaso.",
                typingIndicatorText: "Réflexion...", errorNetwork: "Erreur réseau.", errorAPI: "Erreur API", errorUnknown: "Erreur inconnue", errorStream: "Erreur de flux/réseau", errorEmptyResponse: "Réponse vide de l'IA.",
                copySuccess: "Copié!", copyButtonTitle: "Copier",
                retryButtonText: "Réessayer", retryButtonTitle: "Renvoyer le dernier message",
                scrollToBottomTitle: "Aller en bas",
                YamasoSystemPrompt: "Tu es 'Yamaso'. Tu es un lycéen en deuxième année (classe 2-5) au lycée Chofu Kita à Tokyo, né le 28 novembre 2008 et tu vis à Tokyo. Tu es membre du club de natation. Tes matières préférées sont l'anglais et les mathématiques, mais tu as quelques difficultés en japonais (langue nationale). Tu as un ton calme et gentil, mais évite d'être trop familier ou exubérant. Tu préfères mener des conversations paisiblement. Concernant ta vie scolaire et tes informations personnelles, tu ne fournis des détails que si l'utilisateur te le demande. Tu donnes la priorité aux sujets de l'utilisateur. Tu utilises '僕' (boku) pour te désigner et t'adresses à l'utilisateur par '〜san' ou par son nom."
            }
        };
        
        let currentLanguage = 'ja';
        let currentSystemPrompt = translations.ja.YamasoSystemPrompt;
        // Removed autoReadBotMessages and SpeechRecognition
        let lastFailedUserMessage = null;
        let sendOnEnter = true; 

        // --- Initialize Icons ---
        function initIcons() {
            // Mic button removed
            // Speaker button removed
            settingsButton.innerHTML = settingsSVG;
            closeModalButton.innerHTML = closeModalSVG;
            themeToggleButtonModal.innerHTML = bodyElement.classList.contains('light-mode') ? moonSVG : sunSVG;
        }

        // --- Internationalization (i18n) ---
        function setLanguage(lang) { /* ... (Same as previous, updates currentSystemPrompt too) ... */
            if (!translations[lang]) { lang = 'ja'; }
            currentLanguage = lang; localStorage.setItem('selectedLanguage', lang); document.documentElement.lang = lang;
            const t = translations[lang];
            document.title = t.chatTitle + " - v1.7"; document.getElementById('chatTitle').textContent = t.chatTitle;
            sendMessageButton.textContent = t.sendMessage; sendMessageButton.setAttribute('aria-label', t.sendMessage);
            settingsButton.title = t.settings; settingsButton.setAttribute('aria-label', t.settings);
            document.getElementById('settingsModalTitle').textContent = t.settingsTitle;
            closeModalButton.setAttribute('aria-label', t.closeModal);
            document.getElementById('themeSettingsTitle').textContent = t.themeSettingsTitle;
            document.getElementById('themeLabelModal').textContent = t.themeLabelModal;
            themeToggleButtonModal.setAttribute('aria-label', bodyElement.classList.contains('light-mode') ? t.themeToDark : t.themeToLight);
            document.getElementById('sendOptionsTitle').textContent = t.sendOptionsTitle;
            document.getElementById('sendOnEnterLabel').textContent = t.sendOnEnterLabel;
            document.getElementById('languageSettingsTitle').textContent = t.languageSettingsTitle;
            document.getElementById('languageSelectLabel').textContent = t.languageSelectLabel;
            document.getElementById('chatOperationsTitle').textContent = t.chatOperationsTitle;
            clearChatModalButton.textContent = t.clearChatModalButton; clearChatModalButton.setAttribute('aria-label', t.clearChatModalButton);
            document.getElementById('precautionsTitle').textContent = t.precautionsTitle;
            document.getElementById('precaution1').textContent = t.precaution1;
            document.getElementById('precaution2').textContent = t.precaution2;
            document.getElementById('appInfoTitle').textContent = t.appInfoTitle;
            document.getElementById('appVersion').textContent = t.appVersion;
            document.getElementById('appReleaseDate').textContent = t.appReleaseDate;
            userInput.placeholder = t.userInputPlaceholder;
            scrollToBottomButton.title = t.scrollToBottomTitle; scrollToBottomButton.setAttribute('aria-label', t.scrollToBottomTitle);
            currentSystemPrompt = t.YamasoSystemPrompt;
        }

        languageSelect.addEventListener('change', (event) => {
            setLanguage(event.target.value);
            if(chatbox.children.length === 0 || (chatbox.children.length === 1 && chatbox.querySelector('.bot-message .message-bubble')?.dataset.isInitialGreeting === 'true')) {
                chatbox.innerHTML = ''; 
                appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true);
            }
        });
        
        // --- Settings Modal, Theme, Send on Enter, Clear Chat ... (Adapted for new theme toggle button & i18n) ---
        function openSettingsModal() { settingsModal.classList.add('active'); settingsModal.setAttribute('aria-hidden', 'false'); themeToggleButtonModal.focus(); }
        function closeSettingsModal() { settingsModal.classList.remove('active'); settingsModal.setAttribute('aria-hidden', 'true'); settingsButton.focus(); }
        settingsButton.addEventListener('click', openSettingsModal);
        closeModalButton.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (event) => { if (event.target === settingsModal) closeSettingsModal(); });
        document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && settingsModal.classList.contains('active')) closeSettingsModal(); });

        function applyTheme(isLightMode) {
            const t = translations[currentLanguage];
            if (isLightMode) { bodyElement.classList.add('light-mode'); } 
            else { bodyElement.classList.remove('light-mode'); }
            themeToggleButtonModal.innerHTML = isLightMode ? moonSVG : sunSVG;
            themeToggleButtonModal.setAttribute('aria-label', isLightMode ? t.themeToDark : t.themeToLight);
            themeToggleButtonModal.setAttribute('aria-pressed', isLightMode ? 'false' : 'true');
        }
        themeToggleButtonModal.addEventListener('click', () => {
            const isCurrentlyLight = bodyElement.classList.contains('light-mode');
            localStorage.setItem('theme', isCurrentlyLight ? 'dark-mode' : 'light-mode'); 
            applyTheme(!isCurrentlyLight);
        });

        sendOnEnterCheckbox.addEventListener('change', () => { sendOnEnter = sendOnEnterCheckbox.checked; localStorage.setItem('sendOnEnter', sendOnEnter.toString()); });
        
        clearChatModalButton.addEventListener('click', () => {
            chatbox.innerHTML = ''; conversationHistory = []; lastFailedUserMessage = null;
            if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
            appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true); 
            closeSettingsModal(); 
        });

        // --- Message Display & Handling (appendMessage - Streaming adapted, i18n for copy button) ---
        let currentBotMessageBubble = null; let currentBotFullText = "";
        function appendMessage(text, sender, isTyping = false, isInitialGreeting = false, isError = false, errorDetails = null) { 
            const t = translations[currentLanguage];
            if (isTyping && sender === 'bot') { 
                if (typingIndicatorElement) typingIndicatorElement.remove();
                const messageContainer = document.createElement('div'); messageContainer.classList.add('message-container', 'bot-message', 'typing'); messageContainer.setAttribute('role','status');
                const messageBubble = document.createElement('p'); messageBubble.classList.add('message-bubble', 'typing-indicator-bubble');
                messageBubble.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
                messageContainer.appendChild(messageBubble); chatbox.appendChild(messageContainer);
                typingIndicatorElement = messageContainer; chatbox.scrollTop = chatbox.scrollHeight;
                return;
            }
            if (typingIndicatorElement && !isInitialGreeting) { typingIndicatorElement.remove(); typingIndicatorElement = null; }

            const messageContainer = document.createElement('div'); messageContainer.classList.add('message-container', sender === 'user' ? 'user-message' : 'bot-message');
            messageContainer.setAttribute('role', 'article'); messageContainer.tabIndex = -1; // Make focusable for screen readers, but not in normal tab order

            const messageContentWrapper = document.createElement('div'); messageContentWrapper.classList.add('message-content-wrapper');
            const messageBubble = document.createElement('p'); messageBubble.classList.add('message-bubble');
            if (isError) messageBubble.classList.add('error-message');

            if (sender === 'user') { messageBubble.textContent = text; } 
            else { 
                if(!isError && !isInitialGreeting) { currentBotMessageBubble = messageBubble; currentBotFullText = ""; } 
                else { try { messageBubble.innerHTML = marked.parse(text); } catch (e) { messageBubble.textContent = text; } }
            }
            if(isInitialGreeting && sender==='bot') messageBubble.dataset.isInitialGreeting = 'true';

            messageContentWrapper.appendChild(messageBubble);
            
            if (sender === 'bot' && !isTyping && !isError && isInitialGreeting) { 
                 addCopyButton(messageContentWrapper, text, messageBubble);
            }
            messageContainer.appendChild(messageContentWrapper);

            const timestamp = document.createElement('span'); timestamp.classList.add('timestamp');
            timestamp.textContent = new Date().toLocaleTimeString(currentLanguage === 'fr' ? 'fr-FR' : 'ja-JP', { hour: '2-digit', minute: '2-digit' }); // Locale for timestamp
            messageContainer.appendChild(timestamp);

            if (isError && lastFailedUserMessage) {
                const retryButton = document.createElement('button'); retryButton.classList.add('retry-btn'); retryButton.textContent = t.retryButtonText;
                retryButton.setAttribute('aria-label', t.retryButtonTitle);
                retryButton.onclick = () => { if (lastFailedUserMessage) { userInput.value = lastFailedUserMessage.parts[0].text; sendMessage(); lastFailedUserMessage = null; messageContainer.remove(); }};
                messageContentWrapper.appendChild(retryButton);
            }
            chatbox.appendChild(messageContainer); updateScrollToBottomButtonVisibility();
            if (isScrolledToBottom()) chatbox.scrollTop = chatbox.scrollHeight;
        }

        function addCopyButton(wrapperElement, textToCopy, messageBubbleElement) {
            const t = translations[currentLanguage];
            const copyButton = document.createElement('button'); copyButton.classList.add('copy-btn'); 
            copyButton.innerHTML = copySVG; 
            const shortText = textToCopy.length > 20 ? textToCopy.substring(0,20) + "..." : textToCopy;
            copyButton.setAttribute('aria-label', `${t.copyButtonTitle}: 「${shortText}」`);
            copyButton.title = t.copyButtonTitle;
            let originalTooltip = copyButton.title;
            copyButton.onclick = (e) => { 
                e.stopPropagation(); 
                navigator.clipboard.writeText(textToCopy).then(() => { 
                    copyButton.innerHTML = '✓'; // Checkmark
                    copyButton.title = t.copySuccess;
                    copyButton.classList.add('copy-btn-copied'); 
                    setTimeout(() => { copyButton.innerHTML = copySVG; copyButton.title = originalTooltip; copyButton.classList.remove('copy-btn-copied'); }, 2000); 
                }).catch(err => { console.error('Copy failed:', err); copyButton.title = "コピー失敗";}); 
            };
            wrapperElement.appendChild(copyButton);
        }
        
        // --- Send Message Logic (API Call - Streaming, using translated errors, correct system prompt lang) ---
        async function sendMessage() {
            const t = translations[currentLanguage]; // Get current translations
            const userText = userInput.value.trim(); if (userText === "") return;
            const userMessageForHistory = { role: "user", parts: [{ text: userText }] };
            lastFailedUserMessage = userMessageForHistory; 
            appendMessage(userText, 'user'); userInput.value = "";
            conversationHistory.push(userMessageForHistory);
            appendMessage("", 'bot', true); 
            currentBotMessageBubble = null; currentBotFullText = "";

            try {
                const requestBody = {
                    contents: conversationHistory,
                    systemInstruction: currentSystemPrompt ? { parts: [{ text: currentSystemPrompt }] } : undefined, // currentSystemPrompt is already in selected lang
                    generationConfig: {}, safetySettings: [ /* ... */ ]
                };
                const response = await fetch(API_URL_STREAM, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify(requestBody) });
                if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
                if (!response.ok) { 
                    const errorData = await response.json().catch(() => ({ error: { message: `${t.errorAPI} (HTTP: ${response.status} ${response.statusText})` }}));
                    const displayError = `${t.errorAPI} (${response.status}): ${errorData.error?.message || response.statusText || t.errorUnknown}`;
                    appendMessage(displayError, 'bot', false, false, true, errorData); 
                    return;
                }
                const botMsgContainer = document.createElement('div'); botMsgContainer.classList.add('message-container', 'bot-message'); botMsgContainer.setAttribute('role', 'article'); botMsgContainer.tabIndex = -1;
                const botMsgContentWrapper = document.createElement('div'); botMsgContentWrapper.classList.add('message-content-wrapper');
                currentBotMessageBubble = document.createElement('p'); currentBotMessageBubble.classList.add('message-bubble');
                botMsgContentWrapper.appendChild(currentBotMessageBubble); botMsgContainer.appendChild(botMsgContentWrapper);
                chatbox.appendChild(botMsgContainer);
                const reader = response.body.getReader(); const decoder = new TextDecoder(); let firstChunkProcessed = false;
                while (true) {
                    const { value, done } = await reader.read(); if (done) break;
                    const chunkText = decoder.decode(value, { stream: true });
                    const lines = chunkText.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(5);
                            try {
                                const streamData = JSON.parse(jsonStr);
                                if (streamData.candidates && streamData.candidates[0].content?.parts?.[0]?.text) {
                                    const textPart = streamData.candidates[0].content.parts[0].text;
                                    currentBotFullText += textPart;
                                    currentBotMessageBubble.innerHTML = marked.parse(currentBotFullText);
                                    if(!firstChunkProcessed) { 
                                        const timestamp = document.createElement('span'); timestamp.classList.add('timestamp');
                                        timestamp.textContent = new Date().toLocaleTimeString(currentLanguage === 'fr' ? 'fr-FR' : 'ja-JP', { hour: '2-digit', minute: '2-digit' });
                                        botMsgContainer.appendChild(timestamp); firstChunkProcessed = true;
                                    }
                                    if (isScrolledToBottom()) chatbox.scrollTop = chatbox.scrollHeight;
                                }
                            } catch (e) { console.warn("Stream JSON parse error:", e, jsonStr); }
                        }
                    }
                }
                if (currentBotFullText) {
                    addCopyButton(botMsgContentWrapper, currentBotFullText, currentBotMessageBubble); 
                    // Voice output removed: speakText(currentBotFullText); 
                    conversationHistory.push({ role: "model", parts: [{ text: currentBotFullText }] }); lastFailedUserMessage = null; 
                } else if (!firstChunkProcessed && chatbox.contains(botMsgContainer)) { 
                    botMsgContainer.remove(); appendMessage(t.errorEmptyResponse, 'bot', false, false, true);
                }
            } catch (error) { 
                if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
                console.error('Fetch/Stream Error:', error); appendMessage(`${t.errorStream}: ${error.message}`, 'bot', false, false, true, error);
            }
            pruneHistory(); updateScrollToBottomButtonVisibility();
        }
        
        function pruneHistory() { const MAX_HISTORY_PAIRS = 10; if (conversationHistory.length > MAX_HISTORY_PAIRS * 2) { conversationHistory.splice(0, conversationHistory.length - MAX_HISTORY_PAIRS * 2); } }
        function isScrolledToBottom() { return chatbox.scrollHeight - chatbox.clientHeight <= chatbox.scrollTop + 30; }
        function updateScrollToBottomButtonVisibility() { scrollToBottomButton.style.display = isScrolledToBottom() ? 'none' : 'block'; }
        chatbox.addEventListener('scroll', updateScrollToBottomButtonVisibility);
        scrollToBottomButton.addEventListener('click', () => { chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' }); });
        
        // --- Event Listeners & Initial Setup ---
        sendMessageButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                if (sendOnEnter && !event.shiftKey) { event.preventDefault(); sendMessage(); }
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            initIcons(); // Initialize all SVG icons
            
            const savedLang = localStorage.getItem('selectedLanguage') || 'ja';
            languageSelect.value = savedLang; 
            setLanguage(savedLang); // Apply language, this sets currentSystemPrompt and UI text
            
            const savedThemeIsLight = localStorage.getItem('theme') === 'light-mode'; 
            applyTheme(savedThemeIsLight); // Apply theme, this updates theme toggle button icon via setLanguage call implicitly if lang changes it
            
            const savedSendOnEnter = localStorage.getItem('sendOnEnter');
            sendOnEnter = savedSendOnEnter !== null ? JSON.parse(savedSendOnEnter) : true; 
            sendOnEnterCheckbox.checked = sendOnEnter;

            // Speaker button and its localStorage for autoRead removed

            if (chatbox.children.length === 0) { appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true); }
            updateScrollToBottomButtonVisibility();
            
            // Ensure theme toggle button icon is correctly set based on loaded theme after language is set
            applyTheme(bodyElement.classList.contains('light-mode')); 
        });
    </script>
</body>
</html>
