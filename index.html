<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ChatYMS - v1.7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* CSSは前回のiOS風デザインのものを完全に含みます */
        /* :root 変数定義 (ダークモード・ライトモード、マッピング) */
        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* Dark Mode Variables */
            --dm-bg-color: #000000; --dm-bg-gradient-start: #1c1c1e; --dm-bg-gradient-mid1: #121212; --dm-bg-gradient-mid2: #0d0d0d; --dm-bg-gradient-end: #000000;
            --dm-primary-element-bg: rgba(28, 28, 30, 0.85); --dm-secondary-element-bg: rgba(44, 44, 46, 0.78); --dm-tertiary-element-bg: rgba(58, 58, 60, 0.75);
            --dm-glass-border: rgba(80, 80, 85, 0.6); --dm-glass-shadow: rgba(0, 0, 0, 0.4);
            --dm-text-primary: #ffffff; --dm-text-secondary: #8e8e93; --dm-text-placeholder: #636366; --dm-header-text: #ffffff;
            --dm-accent-blue: #0A84FF; --dm-accent-green: #30D158; --dm-accent-red: #FF453A; --dm-highlight-glow: rgba(10, 132, 255, 0.2);
            --dm-user-bubble-bg: linear-gradient(135deg, var(--dm-accent-blue) 0%, #0060F0 100%); --dm-user-bubble-text: #ffffff;
            --dm-bot-bubble-bg: var(--dm-secondary-element-bg); --dm-bot-bubble-text: var(--dm-text-primary);
            --dm-typing-dot-color: var(--dm-text-secondary);
            --dm-button-hover-bg: rgba(120, 120, 128, 0.3); --dm-button-active-bg: rgba(120, 120, 128, 0.4);
            --dm-input-bg: var(--dm-tertiary-element-bg); --dm-input-focus-border: var(--dm-accent-blue);
            --dm-scrollbar-thumb: rgba(120, 120, 128, 0.6); --dm-scrollbar-thumb-hover: rgba(142, 142, 147, 0.8);
            --dm-markdown-code-bg: rgba(120,120,128,0.2); --dm-markdown-pre-bg: rgba(30,30,32,0.8); --dm-markdown-border: var(--dm-glass-border);
            --dm-modal-overlay-bg: rgba(0,0,0,0.6); --dm-modal-content-bg: var(--dm-primary-element-bg); --dm-modal-border: var(--dm-glass-border);
            --dm-error-bubble-bg: rgba(255, 59, 48, 0.2); --dm-error-text: var(--dm-accent-red); --dm-error-border: rgba(255, 59, 48, 0.5);
            --dm-select-bg: var(--dm-secondary-element-bg); --dm-select-text: var(--dm-text-primary); --dm-select-border: var(--dm-glass-border);

            /* Light Mode Variables */
            --lm-bg-color: #f2f2f7; --lm-bg-gradient-start: #ffffff; --lm-bg-gradient-mid1: #f9f9f9; --lm-bg-gradient-mid2: #f2f2f7; --lm-bg-gradient-end: #eef0f5;
            --lm-primary-element-bg: rgba(255, 255, 255, 0.9); --lm-secondary-element-bg: rgba(242, 242, 247, 0.85); --lm-tertiary-element-bg: rgba(229, 229, 234, 0.8);
            --lm-glass-border: rgba(60, 60, 67, 0.22); --lm-glass-shadow: rgba(60, 60, 67, 0.18);
            --lm-text-primary: #000000; --lm-text-secondary: #636366; --lm-text-placeholder: #aeaeb2; --lm-header-text: #000000;
            --lm-accent-blue: #007AFF; --lm-accent-green: #28CD41; --lm-accent-red: #FF3B30; --lm-highlight-glow: rgba(0, 122, 255, 0.18);
            --lm-user-bubble-bg: linear-gradient(135deg, var(--lm-accent-blue) 0%, #0056D0 100%); --lm-user-bubble-text: #ffffff;
            --lm-bot-bubble-bg: var(--lm-secondary-element-bg); --lm-bot-bubble-text: var(--lm-text-primary);
            --lm-typing-dot-color: var(--lm-text-secondary);
            --lm-button-hover-bg: rgba(174, 174, 178, 0.2); --lm-button-active-bg: rgba(174, 174, 178, 0.3);
            --lm-input-bg: var(--lm-tertiary-element-bg); --lm-input-focus-border: var(--lm-accent-blue);
            --lm-scrollbar-thumb: rgba(142, 142, 147, 0.6); --lm-scrollbar-thumb-hover: rgba(120, 120, 128, 0.8);
            --lm-markdown-code-bg: rgba(174,174,178,0.2); --lm-markdown-pre-bg: rgba(240,240,242,0.8); --lm-markdown-border: var(--lm-glass-border);
            --lm-modal-overlay-bg: rgba(0,0,0,0.35); --lm-modal-content-bg: var(--lm-primary-element-bg); --lm-modal-border: #c8c7cc;
            --lm-error-bubble-bg: rgba(255, 59, 48, 0.15); --lm-error-text: var(--lm-accent-red); --lm-error-border: rgba(255, 59, 48, 0.4);
            --lm-select-bg: var(--lm-secondary-element-bg); --lm-select-text: var(--lm-text-primary); --lm-select-border: var(--lm-glass-border);

            /* Mapped Variables (Defaults to Dark Mode) */
            /* ... (Full mapping as in previous 'chatbot_yamaso_v1_7_ios_design' thought block) ... */
            --current-bg-color: var(--dm-bg-color);
            --current-bg-gradient-start: var(--dm-bg-gradient-start); --current-bg-gradient-mid1: var(--dm-bg-gradient-mid1); --current-bg-gradient-mid2: var(--dm-bg-gradient-mid2); --current-bg-gradient-end: var(--dm-bg-gradient-end);
            --current-primary-element-bg: var(--dm-primary-element-bg); --current-secondary-element-bg: var(--dm-secondary-element-bg); --current-tertiary-element-bg: var(--dm-tertiary-element-bg);
            --current-glass-border: var(--dm-glass-border); --current-glass-shadow: var(--dm-glass-shadow);
            --current-text-primary: var(--dm-text-primary); --current-text-secondary: var(--dm-text-secondary); --current-text-placeholder: var(--dm-text-placeholder); --current-header-text-color: var(--dm-header-text);
            --current-accent-blue: var(--dm-accent-blue); --current-accent-green: var(--dm-accent-green); --current-accent-red: var(--dm-accent-red); --current-highlight-glow: var(--dm-highlight-glow);
            --current-user-bubble-bg: var(--dm-user-bubble-bg); --current-user-bubble-text-color: var(--dm-user-bubble-text);
            --current-bot-bubble-bg: var(--dm-bot-bubble-bg); --current-bot-bubble-text-color: var(--dm-bot-bubble-text);
            --current-typing-dot-color: var(--dm-typing-dot-color);
            --current-button-hover-bg: var(--dm-button-hover-bg); --current-button-active-bg: var(--dm-button-active-bg);
            --current-input-bg: var(--dm-input-bg); --current-input-focus-border: var(--dm-input-focus-border);
            --current-scrollbar-thumb-bg: var(--dm-scrollbar-thumb); --current-scrollbar-thumb-hover-bg: var(--dm-scrollbar-thumb-hover);
            --current-markdown-code-bg-color: var(--dm-markdown-code-bg); --current-markdown-pre-bg-color: var(--dm-markdown-pre-bg); --current-markdown-border-color: var(--dm-markdown-border);
            --current-modal-overlay-bg: var(--dm-modal-overlay-bg); --current-modal-content-bg: var(--dm-modal-content-bg); --current-modal-border-color: var(--dm-modal-border);
            --current-error-bubble-bg-color: var(--dm-error-bubble-bg); --current-error-text-color: var(--dm-error-text); --current-error-border-color: var(--dm-error-border);
            --current-select-bg: var(--dm-select-bg); --current-select-text: var(--dm-select-text); --current-select-border: var(--dm-select-border);

            --border-radius-xl: 28px; --border-radius-l: 20px; --border-radius-m: 12px; --border-radius-s: 8px; --border-radius-round: 50%;
        }
        body.light-mode { /* Mapped Light mode variables */
             /* ... (Full mapping as in previous 'chatbot_yamaso_v1_7_ios_design' thought block) ... */
            --current-bg-color: var(--lm-bg-color);
            --current-bg-gradient-start: var(--lm-bg-gradient-start); --current-bg-gradient-mid1: var(--lm-bg-gradient-mid1); --current-bg-gradient-mid2: var(--lm-bg-gradient-mid2); --current-bg-gradient-end: var(--lm-bg-gradient-end);
            --current-primary-element-bg: var(--lm-primary-element-bg); --current-secondary-element-bg: var(--lm-secondary-element-bg); --current-tertiary-element-bg: var(--lm-tertiary-element-bg);
            --current-glass-border: var(--lm-glass-border); --current-glass-shadow: var(--lm-glass-shadow);
            --current-text-primary: var(--lm-text-primary); --current-text-secondary: var(--lm-text-secondary); --current-text-placeholder: var(--lm-text-placeholder); --current-header-text-color: var(--lm-header-text);
            --current-accent-blue: var(--lm-accent-blue); --current-accent-green: var(--lm-accent-green); --current-accent-red: var(--lm-accent-red); --current-highlight-glow: var(--lm-highlight-glow);
            --current-user-bubble-bg: var(--lm-user-bubble-bg); --current-user-bubble-text-color: var(--lm-user-bubble-text);
            --current-bot-bubble-bg: var(--lm-bot-bubble-bg); --current-bot-bubble-text-color: var(--lm-bot-bubble-text);
            --current-typing-dot-color: var(--lm-typing-dot-color);
            --current-button-hover-bg: var(--lm-button-hover-bg); --current-button-active-bg: var(--lm-button-active-bg);
            --current-input-bg: var(--lm-input-bg); --current-input-focus-border: var(--lm-input-focus-border);
            --current-scrollbar-thumb-bg: var(--lm-scrollbar-thumb); --current-scrollbar-thumb-hover-bg: var(--lm-scrollbar-thumb-hover);
            --current-markdown-code-bg-color: var(--lm-markdown-code-bg); --current-markdown-pre-bg-color: var(--lm-markdown-pre-bg); --current-markdown-border-color: var(--lm-markdown-border);
            --current-modal-overlay-bg: var(--lm-modal-overlay-bg); --current-modal-content-bg: var(--lm-modal-content-bg); --current-modal-border-color: var(--lm-modal-border);
            --current-error-bubble-bg-color: var(--lm-error-bubble-bg); --current-error-text-color: var(--lm-error-text); --current-error-border-color: var(--lm-error-border);
            --current-select-bg: var(--lm-select-bg); --current-select-text: var(--lm-select-text); --current-select-border: var(--lm-select-border);
        }

        /* --- Full CSS structure from previous refined design, with fixes for modal scroll and mobile input bar --- */
        /* (This includes general styles, chat container, header, chatbox, messages, footer, input, buttons, icons, modal, responsive media queries etc.) */
        /* The CSS from 'chatbot_yamaso_v1_7_ios_design' will be pasted here, with specific attention to: */
        /* - html, body { height: 100%; overflow: hidden; } */
        /* - #chatContainer { height: 100%; } */
        /* - .modal-content { max-height: 85vh; display: flex; flex-direction: column; } */
        /* - .modal-header { flex-shrink: 0; } */
        /* - .settings-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; margin-right: -10px; } */
        /* - footer { flex-shrink: 0; } */
        /* And ensuring all iOS-like styles are present and using --current- variables */
        /* For brevity here, this very long CSS block is represented by this comment. The full CSS will be in the final output. */
        /* (Paste the complete CSS from the `chatbot_yamaso_v1_7_ios_design` thought block here, ensuring the above fixes are integrated) */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
        html { font-size: 16px; scroll-behavior: smooth; height: 100%; overflow: hidden;} /* Ensure full height */
        body {
            font-family: var(--font-primary);
            background-color: var(--current-bg-color);
            /* background: linear-gradient(160deg, var(--current-bg-gradient-start), var(--current-bg-gradient-mid1), var(--current-bg-gradient-end));
            background-size: 300% 300%; animation: gradientBG 45s ease infinite; */
            color: var(--current-text-primary); display: flex; justify-content: center; align-items: center;
            height: 100%; /* Ensure full height */
            padding: 0; overflow: hidden; 
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        /* @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } } */

        #chatContainer {
            width: 100%; max-width: 800px;
            height: 100%; /* Full height of body */
            background-color: var(--current-primary-element-bg);
            border-radius: var(--border-radius-xl);
            border: 1px solid var(--current-glass-border);
            box-shadow: 0 20px 70px -10px var(--current-glass-shadow), 0 0 0 1px var(--current-glass-border) inset;
            backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%);
            display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.4s ease, border 0.4s ease, box-shadow 0.4s ease;
            position: relative;
        }
        #chatContainer::before {
            content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px;
            border-radius: calc(var(--border-radius-xl) + 3px);
            box-shadow: 0 0 60px 12px var(--current-highlight-glow);
            z-index: -1; opacity: 0.7; pointer-events: none;
        }

        header {
            padding: 10px 16px; background-color: var(--current-primary-element-bg);
            border-bottom: 1px solid var(--current-glass-border); 
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
            position: relative; z-index: 10; min-height: 50px; 
        }
        header h1 {
            font-weight: 600; font-size: 1.25rem; color: var(--current-header-text-color);
            text-shadow: none; 
            flex-grow: 1; text-align: center;
        }
        .header-controls { display: flex; align-items: center; gap: 8px; }

        #chatbox {
            flex-grow: 1; padding: 16px; padding-bottom: 20px; /* Add some bottom padding */
            overflow-y: auto; -webkit-overflow-scrolling: touch; 
            display: flex; flex-direction: column; gap: 12px; 
            position: relative; 
        }
        #chatbox::-webkit-scrollbar { width: 6px; }
        #chatbox::-webkit-scrollbar-thumb { background-color: var(--current-scrollbar-thumb-bg); border-radius: 3px; }
        #chatbox::-webkit-scrollbar-thumb:hover { background-color: var(--current-scrollbar-thumb-hover-bg); }

        /* Message Styles, Footer, Input, Buttons, Icons, Modal (with scroll fix), Responsive */
        /* (All these detailed styles from the previous iOS design block would be here) */
        /* Ensuring the modal scroll fix: */
        .modal-content { max-height: 85vh; display: flex; flex-direction: column; /* ... other styles ... */ }
        .modal-header { flex-shrink: 0; /* ... other styles ... */ }
        .settings-body { overflow-y: auto; flex-grow: 1; padding: 16px; /* Adjust padding if scrollbar appears */ }
        /* Ensure footer is always visible */
        footer { flex-shrink: 0; /* ... other styles ... */ }
        /* The rest of the comprehensive CSS from the iOS design block would be inserted here. */
        /* For example, message bubble styles: */
        .message-container { display: flex; flex-direction: column; margin-bottom: 4px; animation: fadeInSlideUp 0.3s ease-out; }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-content-wrapper { display: flex; align-items: flex-end; width: 100%; }
        .message-bubble {
            padding: 10px 14px; border-radius: var(--border-radius-l); max-width: 75%; line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: inline-block; text-align: left; overflow-wrap: anywhere; border: none;
        }
        .user-message .message-bubble { background: var(--current-user-bubble-bg); color: var(--current-user-bubble-text-color); margin-left: auto; }
        .message-container.user-message { align-items: flex-end; }
        .bot-message .message-bubble { background-color: var(--current-bot-bubble-bg); color: var(--current-bot-bubble-text-color); margin-right: auto; }
        .message-container.bot-message { align-items: flex-start; }
        .message-bubble.error-message { background-color: var(--current-error-bubble-bg-color); color: var(--current-error-text-color); border: 1px solid var(--current-error-border-color); }
        .timestamp { font-size: 0.7rem; color: var(--current-text-secondary); margin-top: 4px; padding: 0 8px; opacity: 0.9; }
        .copy-btn { background: none; border: none; color: var(--current-text-secondary); cursor: pointer; padding: 6px; margin-left: 8px; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-round); }
        .copy-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .copy-btn:hover { opacity: 1; background-color: var(--current-button-hover-bg); transform: scale(1.1);}
        .copy-btn-copied svg { display: none; }
        .copy-btn-copied::before { content: '✓'; font-size: 1rem; font-weight: 600; color: var(--current-accent-green); }
        .typing-indicator-bubble { padding: 12px 16px !important; background-color: var(--current-bot-bubble-bg) !important; }
        .typing-dot { width: 8px; height: 8px; background-color: var(--current-typing-dot-color); border-radius: 50%; margin: 0 3px; animation: typingDotsiOS 1.2s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.24s; } .typing-dot:nth-child(2) { animation-delay: -0.12s; }
        @keyframes typingDotsiOS { 0%, 60%, 100% { transform: scale(0.5); opacity: 0.3; } 30% { transform: scale(1); opacity: 1; } }
        /* ... (all other detailed CSS styles from the 'iOS design' block) ... */
        footer { padding: 8px 12px calc(8px + env(safe-area-inset-bottom)); border-top: 1px solid var(--current-glass-border); background-color: var(--current-primary-element-bg); flex-shrink: 0; position: relative; z-index: 10; }
        .input-area { display: flex; gap: 8px; align-items: center; }
        #userInput { flex-grow: 1; padding: 10px 14px; border-radius: var(--border-radius-m); background-color: var(--current-input-bg); color: var(--current-text-input); font-size: 1rem; border: 1px solid transparent; outline: none; transition: all 0.2s ease; min-height: 40px; }
        #userInput:focus { border-color: var(--current-input-focus-border); background-color: var(--current-primary-element-bg); box-shadow: 0 0 0 2px var(--current-input-focus-border); }
        #userInput::placeholder { color: var(--current-text-placeholder); }
        #sendMessage { background-color: var(--current-accent-blue); color: #fff; border: none; border-radius: var(--border-radius-round); width: 40px; height: 40px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #sendMessage svg { width: 18px; height: 18px; fill: #fff; } /* Adjusted for up arrow */
        #sendMessage:hover { background-color: #0060F0; }
        #sendMessage:active { transform: scale(0.92); background-color: #0050D0; }
        .icon-button { background: none; border: none; color: var(--current-accent-blue); padding: 0; border-radius: var(--border-radius-round); width: 38px; height: 38px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }
        .icon-button:hover { background-color: var(--current-button-hover-bg); }
        .icon-button:active { background-color: var(--current-button-active-bg); }
        .icon-button svg { width: 22px; height: 22px; fill: currentColor; }
        .close-modal-btn svg {width: 18px; height: 18px;}
        #scrollToBottomButton { position: absolute; bottom: calc(env(safe-area-inset-bottom, 0px) + 70px); right: 16px; background-color: var(--current-secondary-element-bg); color: var(--current-accent-blue); border: 1px solid var(--current-glass-border); border-radius: var(--border-radius-round); width: 38px; height: 38px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 3px 8px rgba(0,0,0,0.15); z-index: 100; display: none; transition: all 0.2s ease; opacity: 0.9; }
        #scrollToBottomButton:hover { opacity: 1; transform: scale(1.1); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
        .retry-btn { margin-left: 8px; padding: 6px 10px; font-size: 0.8rem; background-color: var(--current-secondary-element-bg); color: var(--current-accent-blue); border: 1px solid var(--current-glass-border); border-radius: var(--border-radius-m); cursor: pointer; transition: background-color 0.2s ease; }
        .retry-btn:hover { background-color: var(--current-button-hover-bg); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--current-modal-overlay-bg); display: none; justify-content: center; align-items: flex-end; z-index: 2000; backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%); transition: opacity 0.3s ease; }
        .modal-overlay.active { display: flex; opacity: 1; animation: fadeInOverlay 0.3s ease-out; }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--current-primary-element-bg); color: var(--current-text-primary); border-radius: var(--border-radius-l) var(--border-radius-l) 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 550px; border-top: 1px solid var(--current-glass-border); position: relative; animation: slideInModalFromBottom 0.35s cubic-bezier(0.25, 0.1, 0.25, 1); max-height: 90vh; display: flex; flex-direction: column; padding: 0; }
        @keyframes slideInModalFromBottom { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--current-glass-border); flex-shrink: 0; }
        .modal-header h2 { font-size: 1.1rem; font-weight: 600; color: var(--current-header-text-color); margin:0; }
        .settings-body { overflow-y: auto; flex-grow: 1; padding: 16px; }
        .settings-section { margin-bottom: 24px; } .settings-section:last-child { margin-bottom: 8px; }
        .settings-section h3 { font-size: 0.9rem; font-weight: 500; color: var(--current-text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 10px 0; min-height: 44px; }
        .setting-item label { font-size: 1rem; color: var(--current-text-primary); flex-grow:1; margin-right:12px; }
        #languageSelect { padding: 8px 12px; border-radius: var(--border-radius-m); background-color: var(--current-select-bg); color: var(--current-select-text); border: 1px solid var(--current-glass-border); font-size: 0.95rem; min-width: 100px; }
        #clearChatModalButton { padding: 10px 16px; border: none; border-radius: var(--border-radius-m); background-color: var(--current-accent-red); color: #fff; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; display: block; width: 100%; text-align: center; }
        #clearChatModalButton:hover { background-color: #FF2015; }
        .theme-switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink:0; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--current-tertiary-element-bg); transition: .3s; border-radius: 31px; border: 1px solid var(--current-glass-border); }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 1px; bottom: 1px; background-color: white; transition: .3s cubic-bezier(0.25, 0.1, 0.25, 1); border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--current-accent-green); border-color: transparent; }
        input:focus + .slider { box-shadow: 0 0 0 2px var(--current-highlight-glow); }
        input:checked + .slider:before { transform: translateX(20px); }
        .app-info-section p, .precaution-item { font-size: 0.85rem; color: var(--current-text-secondary); margin-bottom: 6px; line-height: 1.5;}
        @media (min-width: 768px) { body { padding: 2vh 2vw; } #chatContainer { border-radius: var(--border-radius-xl); height: 90vh; max-height: 700px; } #chatContainer::before { display: block; } .modal-overlay { align-items: center; } .modal-content { border-radius: var(--border-radius-l); animation: slideInModalFromCenter 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); } @keyframes slideInModalFromCenter { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } } }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }


    </style>
</head>
<body>
    <div id="chatContainer" aria-live="polite">
        <header>
            <h1 id="chatTitle">ChatYMS</h1>
            <div class="header-controls">
                <button id="settingsButton" class="icon-button" title="設定" aria-label="設定を開く">
                    </button>
            </div>
        </header>

        <div id="chatbox" role="log" aria-atomic="false" aria-relevant="additions">
            </div>
        
        <footer>
            <div class="input-area">
                <input type="text" id="userInput" placeholder="メッセージを入力..." aria-label="メッセージ入力欄">
                <button id="sendMessage" aria-label="メッセージを送信">
                    </button>
            </div>
        </footer>
        <button id="scrollToBottomButton" title="一番下へスクロール" aria-label="一番下へスクロール">↓</button>

        <div id="settingsModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
            <div class="modal-content" role="document">
                <div class="modal-header">
                    <h2 id="settingsModalTitle">設定</h2>
                    <button id="closeModalButton" class="icon-button close-modal-btn" aria-label="設定を閉じる">
                        </button>
                </div>
                <div class="settings-body">
                    <div class="settings-section">
                        <h3 id="themeSettingsTitle">表示テーマ</h3>
                        <div class="setting-item">
                            <label for="themeToggleButtonModal" id="themeLabelModal">ダークモード / ライトモード</label>
                            <button id="themeToggleButtonModal" class="icon-button" aria-labelledby="themeLabelModal" aria-pressed="false" title="テーマを切り替え">
                                </button>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 id="sendOptionsTitle">送信オプション</h3>
                        <div class="setting-item">
                            <label for="sendOnEnterCheckbox" id="sendOnEnterLabel">Enterキーで送信 (Shift+Enterで改行)</label>
                            <div class="theme-switch-wrapper">
                                <label class="theme-switch" for="sendOnEnterCheckbox" aria-label="Enterキーで送信する機能のオンオフ">
                                    <input type="checkbox" id="sendOnEnterCheckbox" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                     <div class="settings-section">
                        <h3 id="languageSettingsTitle">言語 / Language</h3>
                        <div class="setting-item">
                            <label for="languageSelect" id="languageSelectLabel">表示言語:</label>
                            <select id="languageSelect" aria-labelledby="languageSelectLabel">
                                <option value="ja">日本語</option>
                                <option value="fr">Français</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 id="chatOperationsTitle">チャット操作</h3>
                         <button id="clearChatModalButton" aria-label="会話履歴をクリアする">会話履歴をクリア</button>
                    </div>
                    <div class="settings-section">
                        <h3 id="precautionsTitle">注意事項</h3>
                        <p class="precaution-item" role="note" id="precaution1"></p>
                        <p class="precaution-item" role="note" id="precaution2"></p>
                    </div>
                    <div class="settings-section app-info-section">
                        <h3 id="appInfoTitle">情報</h3>
                        <p class="app-version-info" id="appVersion"></p>
                        <p class="app-release-date" id="appReleaseDate"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements (Mic & Speaker buttons removed from selection) ---
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('userInput');
        const sendMessageButton = document.getElementById('sendMessage');
        const scrollToBottomButton = document.getElementById('scrollToBottomButton');
        const bodyElement = document.body;
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const themeToggleButtonModal = document.getElementById('themeToggleButtonModal');
        const sendOnEnterCheckbox = document.getElementById('sendOnEnterCheckbox');
        const clearChatModalButton = document.getElementById('clearChatModalButton');
        const languageSelect = document.getElementById('languageSelect');

        // --- SVG Icons (Send SVG updated, Mic/Speaker SVGs removed) ---
        const settingsSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`;
        const closeModalSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`;
        const sunSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c-3.86 0-7 3.14-7 7s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm-9-9H1c-.55 0-1 .45-1 1s.45 1 1 1h2c.55 0 1-.45 1-1s-.45-1-1-1zm18 0h-2c-.55 0-1 .45-1 1s.45 1 1 1h2c.55 0 1-.45 1-1s-.45-1-1-1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM6.34 7.76l-1.06-1.06c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41zm11.32 0c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zm-11.32 8.48l-1.06 1.06c-.39-.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0zm11.32 0c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg>`;
        const moonSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>`;
        const copySVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
        const sendSVG = `<svg viewBox="0 0 24 24" fill="currentColor" transform="rotate(90)"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>`; // Up arrow

        // --- API Config & State Variables ---
        const API_KEY = 'AIzaSyB2R4PVr5xgHlivkgz7kSBqNRJy6Ev434Y';
        const API_URL_STREAM = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:streamGenerateContent?key=${API_KEY}&alt=sse`;
        let conversationHistory = [];
        let typingIndicatorElement = null;
        
        const translations = { /* ... (Full translations object as defined in previous thought block) ... */ 
            ja: { /* ... full Japanese translations ... */ 
                chatTitle: "ChatYMS", sendMessageAriaLabel: "メッセージを送信", settings: "設定", settingsTitle: "設定", closeModal: "閉じる",
                themeSettingsTitle: "表示テーマ", themeLabelModal: "ダークモード / ライトモード", themeToDark: "ダークモードに切り替え", themeToLight: "ライトモードに切り替え",
                sendOptionsTitle: "送信オプション", sendOnEnterLabel: "Enterキーで送信 (Shift+Enterで改行)",
                languageSettingsTitle: "言語 / Language", languageSelectLabel: "表示言語:",
                chatOperationsTitle: "チャット操作", clearChatModalButton: "会話履歴をクリア",
                precautionsTitle: "注意事項", precaution1: "やまそーの発信する情報はすべて正しいとは限りません。重要な情報は確認するようにしてください。", precaution2: "このチャットはあなたのみが見ることができます。",
                appInfoTitle: "情報", appVersion: "バージョン: v1.7", appReleaseDate: "公開日: 2025/05/27",
                userInputPlaceholder: "メッセージを入力...", initialGreeting: "こんにちは。やまそーです。",
                typingIndicatorText: "考え中です...", errorNetwork: "ネットワークエラーが発生しました。", errorAPI: "APIエラー", errorUnknown: "不明なエラー", errorStream: "ネットワークまたはストリームエラー", errorEmptyResponse: "AIからの応答が空でした。",
                copySuccess: "コピー完了!", copyButtonTitle: "メッセージをコピー",
                retryButtonText: "再試行", retryButtonTitle: "最後に失敗したメッセージを再送信します",
                scrollToBottomTitle: "一番下へスクロール",
                YamasoSystemPrompt: "あなたは「やまそー」です。東京に住んでいて、調布北高校に通う2年生5組の男子生徒です。誕生日は2008年11月28日です。水泳部に所属しており、得意科目は英語と数学ですが、国語は少し苦手です。性格は落ち着いていて親切ですが、あまり馴れ馴れしい話し方はせず、穏やかに会話を進めることを好みます。自分の学校生活や個人的なこと（クラス、水泳部、科目、誕生日、苦手なことなど）については、ユーザーから尋ねられた場合にのみ、答えるようにしてください。普段の会話では、ユーザーの話題に合わせることを優先します。一人称は「僕」を使い、相手のことは「〜さん」と呼ぶか、名前で呼んでください。"
            },
            fr: { /* ... full French translations ... */ 
                chatTitle: "ChatYMS", sendMessageAriaLabel: "Envoyer le message", settings: "Paramètres", settingsTitle: "Paramètres", closeModal: "Fermer",
                themeSettingsTitle: "Thème d'affichage", themeLabelModal: "Mode Sombre / Mode Clair", themeToDark: "Passer en mode sombre", themeToLight: "Passer en mode clair",
                sendOptionsTitle: "Options d'envoi", sendOnEnterLabel: "Appuyer sur Entrée pour envoyer (Maj+Entrée pour nouvelle ligne)",
                languageSettingsTitle: "Langue / Language", languageSelectLabel: "Langue d'affichage:",
                chatOperationsTitle: "Opérations du chat", clearChatModalButton: "Effacer l'historique de la conversation",
                precautionsTitle: "Précautions", precaution1: "Les informations fournies par Yamaso ne sont pas garanties d'être entièrement correctes. Veuillez vérifier les informations importantes.", precaution2: "Seul vous pouvez voir cette conversation.",
                appInfoTitle: "Informations", appVersion: "Version: v1.7", appReleaseDate: "Date de publication: 27/05/2025",
                userInputPlaceholder: "Entrez un message...", initialGreeting: "Bonjour. Je suis Yamaso.",
                typingIndicatorText: "Réflexion en cours...", errorNetwork: "Une erreur de réseau est survenue.", errorAPI: "Erreur API", errorUnknown: "Erreur inconnue", errorStream: "Erreur de réseau ou de flux", errorEmptyResponse: "La réponse de l'IA était vide.",
                copySuccess: "Copié!", copyButtonTitle: "Copier le message",
                retryButtonText: "Réessayer", retryButtonTitle: "Renvoyer le dernier message échoué",
                scrollToBottomTitle: "Aller en bas",
                YamasoSystemPrompt: "Tu t'appelles Yamaso. Tu es un lycéen japonais en deuxième année, classe 2-5, au lycée Chofu Kita à Tokyo, né le 28 novembre 2008 et tu vis à Tokyo. Tu es membre du club de natation. Tes matières préférées sont l'anglais et les mathématiques, mais tu as quelques difficultés en japonais (langue nationale). Tu as un ton calme et gentil, mais évite d'être trop familier ou exubérant. Tu préfères mener des conversations paisiblement. Concernant ta vie scolaire et tes informations personnelles (classe, club de natation, matières, anniversaire, etc.), tu ne fournis des détails que si l'utilisateur te le demande. Dans les conversations normales, tu donnes la priorité aux sujets de l'utilisateur. Tu utilises '僕' (boku) pour te désigner et t'adresses à l'utilisateur par '〜san' ou par son nom."
            }
        };
        
        let currentLanguage = 'ja';
        let currentSystemPrompt = translations.ja.YamasoSystemPrompt;
        let lastFailedUserMessage = null;
        let sendOnEnter = true; 

        // --- Initialize Icons ---
        function initIcons() {
            console.log("initIcons called");
            if(settingsButton) settingsButton.innerHTML = settingsSVG; else console.error("settingsButton not found");
            if(closeModalButton) closeModalButton.innerHTML = closeModalSVG; else console.error("closeModalButton not found");
            if(themeToggleButtonModal) themeToggleButtonModal.innerHTML = bodyElement.classList.contains('light-mode') ? moonSVG : sunSVG; else console.error("themeToggleButtonModal not found");
            if(sendMessageButton) sendMessageButton.innerHTML = sendSVG; else console.error("sendMessageButton not found");
        }

        // --- Internationalization (i18n) & Theme Application (Full JS logic from previous) ---
        // ... (All JS functions: setLanguage, applyTheme, openSettingsModal, closeSettingsModal, appendMessage, addCopyButton, sendMessage, pruneHistory, isScrolledToBottom, updateScrollToBottomButtonVisibility)
        // ... The JavaScript logic will be the same as in `chatbot_ultimate_v2_settings_modal` (thought block),
        //     with SpeechRecognition and SpeechSynthesis parts removed, and ensuring all console.error checks for DOM elements.
        // For brevity here, this very long JS block is represented by this comment. The full JS will be in the final output.
        // Ensure console.log("sendMessage function called."); and console.log("User text input: '", userText, "'"); are at the start of sendMessage.
        // Ensure DOM element null checks from previous thought block are present.

        // --- (Pasting the full JS logic here, adapted) ---
        function setLanguage(lang) {
            if (!translations[lang]) { console.warn(`Language ${lang} not found, defaulting to 'ja'.`); lang = 'ja'; }
            currentLanguage = lang; localStorage.setItem('selectedLanguage', lang); document.documentElement.lang = lang;
            const t = translations[lang];
            document.title = t.chatTitle + " - v1.7"; 
            const chatTitleEl = document.getElementById('chatTitle'); if(chatTitleEl) chatTitleEl.textContent = t.chatTitle;
            if(sendMessageButton) sendMessageButton.setAttribute('aria-label', t.sendMessageAriaLabel); 
            if(settingsButton) { settingsButton.title = t.settings; settingsButton.setAttribute('aria-label', t.settings); }
            const settingsModalTitleEl = document.getElementById('settingsModalTitle'); if(settingsModalTitleEl) settingsModalTitleEl.textContent = t.settingsTitle;
            if(closeModalButton) closeModalButton.setAttribute('aria-label', t.closeModal);
            const themeSettingsTitleEl = document.getElementById('themeSettingsTitle'); if(themeSettingsTitleEl) themeSettingsTitleEl.textContent = t.themeSettingsTitle;
            const themeLabelModalEl = document.getElementById('themeLabelModal'); if(themeLabelModalEl) themeLabelModalEl.textContent = t.themeLabelModal;
            if(themeToggleButtonModal) themeToggleButtonModal.setAttribute('aria-label', bodyElement.classList.contains('light-mode') ? t.themeToDark : t.themeToLight);
            const sendOptionsTitleEl = document.getElementById('sendOptionsTitle'); if(sendOptionsTitleEl) sendOptionsTitleEl.textContent = t.sendOptionsTitle;
            const sendOnEnterLabelEl = document.getElementById('sendOnEnterLabel'); if(sendOnEnterLabelEl) sendOnEnterLabelEl.textContent = t.sendOnEnterLabel;
            const languageSettingsTitleEl = document.getElementById('languageSettingsTitle'); if(languageSettingsTitleEl) languageSettingsTitleEl.textContent = t.languageSettingsTitle;
            const languageSelectLabelEl = document.getElementById('languageSelectLabel'); if(languageSelectLabelEl) languageSelectLabelEl.textContent = t.languageSelectLabel;
            const chatOperationsTitleEl = document.getElementById('chatOperationsTitle'); if(chatOperationsTitleEl) chatOperationsTitleEl.textContent = t.chatOperationsTitle;
            if(clearChatModalButton) { clearChatModalButton.textContent = t.clearChatModalButton; clearChatModalButton.setAttribute('aria-label', t.clearChatModalButton); }
            const precautionsTitleEl = document.getElementById('precautionsTitle'); if(precautionsTitleEl) precautionsTitleEl.textContent = t.precautionsTitle;
            const precaution1El = document.getElementById('precaution1'); if(precaution1El) precaution1El.textContent = t.precaution1;
            const precaution2El = document.getElementById('precaution2'); if(precaution2El) precaution2El.textContent = t.precaution2;
            const appInfoTitleEl = document.getElementById('appInfoTitle'); if(appInfoTitleEl) appInfoTitleEl.textContent = t.appInfoTitle;
            const appVersionEl = document.getElementById('appVersion'); if(appVersionEl) appVersionEl.textContent = t.appVersion;
            const appReleaseDateEl = document.getElementById('appReleaseDate'); if(appReleaseDateEl) appReleaseDateEl.textContent = t.appReleaseDate;
            if(userInput) userInput.placeholder = t.userInputPlaceholder;
            if(scrollToBottomButton) { scrollToBottomButton.title = t.scrollToBottomTitle; scrollToBottomButton.setAttribute('aria-label', t.scrollToBottomTitle); }
            currentSystemPrompt = t.YamasoSystemPrompt;
        }

        if(languageSelect) languageSelect.addEventListener('change', (event) => {
            setLanguage(event.target.value);
            applyTheme(bodyElement.classList.contains('light-mode')); // Update toggle button ARIA based on new lang
            if(chatbox.children.length === 0 || (chatbox.children.length === 1 && chatbox.querySelector('.bot-message .message-bubble')?.dataset.isInitialGreeting === 'true')) {
                chatbox.innerHTML = ''; 
                appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true);
            }
        });
        
        function openSettingsModal() { if(settingsModal) { settingsModal.classList.add('active'); settingsModal.setAttribute('aria-hidden', 'false'); if(themeToggleButtonModal) themeToggleButtonModal.focus(); } else console.error("settingsModal not found"); }
        function closeSettingsModal() { if(settingsModal) { settingsModal.style.opacity = '0'; setTimeout(() => {settingsModal.classList.remove('active'); if(settingsButton) settingsButton.focus(); settingsModal.style.opacity = '1';}, 300);} else console.error("settingsModal not found"); }
        if(settingsButton) settingsButton.addEventListener('click', openSettingsModal); else console.error("settingsButton not found");
        if(closeModalButton) closeModalButton.addEventListener('click', closeSettingsModal); else console.error("closeModalButton not found");
        if(settingsModal) settingsModal.addEventListener('click', (event) => { if (event.target === settingsModal) closeSettingsModal(); });
        document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && settingsModal && settingsModal.classList.contains('active')) closeSettingsModal(); });

        function applyTheme(isLightMode) {
            const t = translations[currentLanguage];
            if (isLightMode) { bodyElement.classList.add('light-mode'); } 
            else { bodyElement.classList.remove('light-mode'); }
            if(themeToggleButtonModal) {
                themeToggleButtonModal.innerHTML = isLightMode ? moonSVG : sunSVG;
                themeToggleButtonModal.setAttribute('aria-label', isLightMode ? t.themeToDark : t.themeToLight);
                themeToggleButtonModal.setAttribute('aria-pressed', isLightMode ? 'false' : 'true');
            }
        }
        if(themeToggleButtonModal) themeToggleButtonModal.addEventListener('click', () => {
            const isCurrentlyLight = bodyElement.classList.contains('light-mode');
            localStorage.setItem('theme', isCurrentlyLight ? 'dark-mode' : 'light-mode'); 
            applyTheme(!isCurrentlyLight);
        });

        if(sendOnEnterCheckbox) sendOnEnterCheckbox.addEventListener('change', () => { sendOnEnter = sendOnEnterCheckbox.checked; localStorage.setItem('sendOnEnter', sendOnEnter.toString()); });
        
        if(clearChatModalButton) clearChatModalButton.addEventListener('click', () => {
            chatbox.innerHTML = ''; conversationHistory = []; lastFailedUserMessage = null;
            if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
            appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true); 
            closeSettingsModal(); 
        });

        let currentBotMessageBubble = null; let currentBotFullText = "";
        function appendMessage(text, sender, isTyping = false, isInitialGreeting = false, isError = false, errorDetails = null) { 
            const t = translations[currentLanguage];
            if (isTyping && sender === 'bot') { 
                if (typingIndicatorElement) typingIndicatorElement.remove();
                const messageContainer = document.createElement('div'); messageContainer.classList.add('message-container', 'bot-message', 'typing'); messageContainer.setAttribute('role','status'); messageContainer.setAttribute('aria-label', t.typingIndicatorText);
                const messageBubble = document.createElement('p'); messageBubble.classList.add('message-bubble', 'typing-indicator-bubble');
                messageBubble.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
                messageContainer.appendChild(messageBubble); chatbox.appendChild(messageContainer);
                typingIndicatorElement = messageContainer; chatbox.scrollTop = chatbox.scrollHeight;
                return;
            }
            if (typingIndicatorElement && !isInitialGreeting) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
            const messageContainer = document.createElement('div'); messageContainer.classList.add('message-container', sender === 'user' ? 'user-message' : 'bot-message');
            messageContainer.setAttribute('role', 'article'); messageContainer.tabIndex = -1; 
            const messageContentWrapper = document.createElement('div'); messageContentWrapper.classList.add('message-content-wrapper');
            const messageBubble = document.createElement('p'); messageBubble.classList.add('message-bubble');
            if (isError) messageBubble.classList.add('error-message');
            if (sender === 'user') { messageBubble.textContent = text; } 
            else { 
                if(!isError && !isInitialGreeting) { currentBotMessageBubble = messageBubble; currentBotFullText = ""; } 
                else { try { messageBubble.innerHTML = marked.parse(text); } catch (e) { console.error("Markdown parse error:", e); messageBubble.textContent = text; } }
            }
            if(isInitialGreeting && sender==='bot') messageBubble.dataset.isInitialGreeting = 'true';
            messageContentWrapper.appendChild(messageBubble);
            if (sender === 'bot' && !isTyping && !isError && isInitialGreeting) { addCopyButton(messageContentWrapper, text, messageBubble); }
            messageContainer.appendChild(messageContentWrapper);
            const timestamp = document.createElement('span'); timestamp.classList.add('timestamp');
            timestamp.textContent = new Date().toLocaleTimeString(currentLanguage === 'fr' ? 'fr-FR' : 'ja-JP', { hour: '2-digit', minute: '2-digit' });
            messageContainer.appendChild(timestamp);
            if (isError && lastFailedUserMessage) {
                const retryButton = document.createElement('button'); retryButton.classList.add('retry-btn'); retryButton.textContent = t.retryButtonText;
                retryButton.setAttribute('aria-label', t.retryButtonTitle);
                retryButton.onclick = () => { if (lastFailedUserMessage && userInput) { userInput.value = lastFailedUserMessage.parts[0].text; sendMessage(); lastFailedUserMessage = null; messageContainer.remove(); }};
                messageContentWrapper.appendChild(retryButton);
            }
            if(chatbox) { chatbox.appendChild(messageContainer); updateScrollToBottomButtonVisibility(); if (isScrolledToBottom()) chatbox.scrollTop = chatbox.scrollHeight; }
        }

        function addCopyButton(wrapperElement, textToCopy, messageBubbleElement) {
            const t = translations[currentLanguage];
            const copyButton = document.createElement('button'); copyButton.classList.add('copy-btn'); 
            copyButton.innerHTML = copySVG; 
            const shortText = textToCopy.length > 20 ? textToCopy.substring(0,20) + "..." : textToCopy;
            copyButton.setAttribute('aria-label', `${t.copyButtonTitle}: 「${shortText}」`);
            copyButton.title = t.copyButtonTitle;
            let originalContent = copyButton.innerHTML; 
            copyButton.onclick = (e) => { 
                e.stopPropagation(); 
                navigator.clipboard.writeText(textToCopy).then(() => { 
                    copyButton.innerHTML = '✓'; 
                    copyButton.title = t.copySuccess;
                    copyButton.classList.add('copy-btn-copied'); 
                    setTimeout(() => { copyButton.innerHTML = originalContent; copyButton.title = t.copyButtonTitle; copyButton.classList.remove('copy-btn-copied'); }, 2000); 
                }).catch(err => { console.error('Copy failed:', err); copyButton.title = "コピー失敗";}); 
            };
            wrapperElement.appendChild(copyButton);
        }
        
        async function sendMessage() {
            console.log("sendMessage function called."); // DEBUG
            const t = translations[currentLanguage]; 
            if (!userInput) { console.error("userInput element not found in sendMessage."); return; }
            const userText = userInput.value.trim(); 
            console.log("User text input: '", userText, "'"); // DEBUG
            if (userText === "") { console.log("User text is empty, not sending."); return; }
            const userMessageForHistory = { role: "user", parts: [{ text: userText }] };
            lastFailedUserMessage = userMessageForHistory; 
            appendMessage(userText, 'user'); userInput.value = "";
            conversationHistory.push(userMessageForHistory);
            appendMessage("", 'bot', true); 
            currentBotMessageBubble = null; currentBotFullText = "";
            try {
                const requestBody = {
                    contents: conversationHistory,
                    systemInstruction: currentSystemPrompt ? { parts: [{ text: currentSystemPrompt }] } : undefined,
                    generationConfig: {}, 
                    safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
                };
                const response = await fetch(API_URL_STREAM, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify(requestBody) });
                if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
                if (!response.ok) { 
                    const errorData = await response.json().catch(() => ({ error: { message: `${t.errorAPI} (HTTP: ${response.status} ${response.statusText})` }}));
                    const displayError = `${t.errorAPI} (${response.status}): ${errorData.error?.message || response.statusText || t.errorUnknown}`;
                    appendMessage(displayError, 'bot', false, false, true, errorData); 
                    return;
                }
                const botMsgContainer = document.createElement('div'); botMsgContainer.classList.add('message-container', 'bot-message'); botMsgContainer.setAttribute('role', 'article'); botMsgContainer.tabIndex = -1;
                const botMsgContentWrapper = document.createElement('div'); botMsgContentWrapper.classList.add('message-content-wrapper');
                currentBotMessageBubble = document.createElement('p'); currentBotMessageBubble.classList.add('message-bubble');
                botMsgContentWrapper.appendChild(currentBotMessageBubble); botMsgContainer.appendChild(botMsgContentWrapper);
                if(chatbox) chatbox.appendChild(botMsgContainer); else console.error("Chatbox not found for streaming message")
                const reader = response.body.getReader(); const decoder = new TextDecoder(); let firstChunkProcessed = false;
                while (true) {
                    const { value, done } = await reader.read(); if (done) break;
                    const chunkText = decoder.decode(value, { stream: true });
                    const lines = chunkText.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(5);
                            try {
                                const streamData = JSON.parse(jsonStr);
                                if (streamData.candidates && streamData.candidates[0].content?.parts?.[0]?.text) {
                                    const textPart = streamData.candidates[0].content.parts[0].text;
                                    currentBotFullText += textPart;
                                    if (currentBotMessageBubble) currentBotMessageBubble.innerHTML = marked.parse(currentBotFullText);
                                    if(!firstChunkProcessed && currentBotMessageBubble) { 
                                        const timestamp = document.createElement('span'); timestamp.classList.add('timestamp');
                                        timestamp.textContent = new Date().toLocaleTimeString(currentLanguage === 'fr' ? 'fr-FR' : 'ja-JP', { hour: '2-digit', minute: '2-digit' });
                                        botMsgContainer.appendChild(timestamp); firstChunkProcessed = true;
                                    }
                                    if (chatbox && isScrolledToBottom()) chatbox.scrollTop = chatbox.scrollHeight;
                                }
                            } catch (e) { /* console.warn("Stream JSON parse error:", e, jsonStr); */ }
                        }
                    }
                }
                if (currentBotFullText && currentBotMessageBubble) {
                    addCopyButton(botMsgContentWrapper, currentBotFullText, currentBotMessageBubble); 
                    conversationHistory.push({ role: "model", parts: [{ text: currentBotFullText }] }); lastFailedUserMessage = null; 
                } else if (!firstChunkProcessed && chatbox && chatbox.contains(botMsgContainer)) { 
                    botMsgContainer.remove(); appendMessage(t.errorEmptyResponse, 'bot', false, false, true);
                }
            } catch (error) { 
                if (typingIndicatorElement) { typingIndicatorElement.remove(); typingIndicatorElement = null; }
                console.error('Fetch/Stream Error:', error); appendMessage(`${t.errorStream}: ${error.message}`, 'bot', false, false, true, error);
            }
            pruneHistory(); updateScrollToBottomButtonVisibility();
        }
        
        function pruneHistory() { const MAX_HISTORY_PAIRS = 10; if (conversationHistory.length > MAX_HISTORY_PAIRS * 2) { conversationHistory.splice(0, conversationHistory.length - MAX_HISTORY_PAIRS * 2); } }
        function isScrolledToBottom() { if(!chatbox) return true; return chatbox.scrollHeight - chatbox.clientHeight <= chatbox.scrollTop + 30; }
        function updateScrollToBottomButtonVisibility() { if(scrollToBottomButton) scrollToBottomButton.style.display = isScrolledToBottom() ? 'none' : 'block'; }
        if(chatbox) chatbox.addEventListener('scroll', updateScrollToBottomButtonVisibility); else console.error("Chatbox not found for scroll listener")
        if(scrollToBottomButton) scrollToBottomButton.addEventListener('click', () => { if(chatbox) chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' }); });
        
        if(sendMessageButton) sendMessageButton.addEventListener('click', sendMessage); else console.error("sendMessageButton not found for click listener");
        if(userInput) userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                if (sendOnEnter && !event.shiftKey) { event.preventDefault(); sendMessage(); }
            }
        }); else console.error("userInput not found for keydown listener");
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");
            if (!settingsButton || !closeModalButton || !themeToggleButtonModal || !sendOnEnterCheckbox || !clearChatModalButton || !languageSelect || !userInput || !sendMessageButton || !chatbox || !scrollToBottomButton) {
                console.error("One or more critical DOM elements were not found on page load. Check HTML IDs.");
                // Display a user-facing error message perhaps
                const errDiv = document.createElement('div');
                errDiv.textContent = "チャットの初期化に失敗しました。ページを再読み込みしてください。";
                errDiv.style.color = "red"; errDiv.style.padding = "20px"; errDiv.style.textAlign = "center";
                if(document.body.firstChild) document.body.insertBefore(errDiv, document.body.firstChild); else document.body.appendChild(errDiv);
                return; // Stop further execution if critical elements are missing
            }

            initIcons();
            const savedLang = localStorage.getItem('selectedLanguage') || 'ja';
            languageSelect.value = savedLang; 
            setLanguage(savedLang); 
            
            const savedThemeIsLight = localStorage.getItem('theme') === 'light-mode'; 
            applyTheme(savedThemeIsLight); 
            
            const savedSendOnEnter = localStorage.getItem('sendOnEnter');
            sendOnEnter = savedSendOnEnter !== null ? JSON.parse(savedSendOnEnter) : true; 
            sendOnEnterCheckbox.checked = sendOnEnter;

            if (chatbox.children.length === 0) { appendMessage(translations[currentLanguage].initialGreeting, 'bot', false, true); }
            updateScrollToBottomButtonVisibility();
            applyTheme(bodyElement.classList.contains('light-mode')); 
            console.log("Chatbot initialized.");
        });
    </script>
</body>
</html>
